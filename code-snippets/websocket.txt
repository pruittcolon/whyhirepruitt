"""
WebSocket Real-Time Communication
services/api-gateway/src/websocket_manager.py

Real-time features:
- Bidirectional streaming
- Connection management
- Broadcast to rooms
- Heartbeat monitoring
"""

from fastapi import WebSocket, WebSocketDisconnect
from typing import Dict, List, Set, Optional
import asyncio
import json
import logging

logger = logging.getLogger(__name__)

class ConnectionManager:
    """Manages WebSocket connections for real-time updates."""
    
    def __init__(self):
        self.active_connections: Dict[str, WebSocket] = {}
        self.rooms: Dict[str, Set[str]] = {}
        self.heartbeat_interval = 30
        
    async def connect(self, websocket: WebSocket, client_id: str):
        """Accept new WebSocket connection."""
        await websocket.accept()
        self.active_connections[client_id] = websocket
        logger.info(f"Client {client_id} connected. Total: {len(self.active_connections)}")
        
        # Start heartbeat
        asyncio.create_task(self._heartbeat(client_id))
        
    def disconnect(self, client_id: str):
        """Remove disconnected client."""
        if client_id in self.active_connections:
            del self.active_connections[client_id]
            # Remove from all rooms
            for room in self.rooms.values():
                room.discard(client_id)
            logger.info(f"Client {client_id} disconnected")
            
    async def send_personal(self, client_id: str, message: dict):
        """Send message to specific client."""
        if client_id in self.active_connections:
            websocket = self.active_connections[client_id]
            await websocket.send_json(message)
            
    async def broadcast(self, message: dict, exclude: Set[str] = None):
        """Send message to all connected clients."""
        exclude = exclude or set()
        for client_id, websocket in self.active_connections.items():
            if client_id not in exclude:
                try:
                    await websocket.send_json(message)
                except Exception:
                    await self.disconnect(client_id)
                    
    async def broadcast_to_room(self, room: str, message: dict):
        """Send message to all clients in a room."""
        if room in self.rooms:
            for client_id in self.rooms[room]:
                await self.send_personal(client_id, message)
                
    def join_room(self, client_id: str, room: str):
        """Add client to a room."""
        if room not in self.rooms:
            self.rooms[room] = set()
        self.rooms[room].add(client_id)
        
    async def stream_transcription(self, client_id: str, text_generator):
        """Stream transcription results to client."""
        async for partial_text in text_generator:
            await self.send_personal(client_id, {
                "type": "transcription",
                "text": partial_text,
                "is_final": False
            })
            
    async def _heartbeat(self, client_id: str):
        """Send periodic heartbeat to detect dead connections."""
        while client_id in self.active_connections:
            try:
                await self.send_personal(client_id, {"type": "ping"})
                await asyncio.sleep(self.heartbeat_interval)
            except Exception:
                self.disconnect(client_id)
                break
