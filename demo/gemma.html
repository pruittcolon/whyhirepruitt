<!DOCTYPE html>
<html lang="en">

<head>
  <script src="assets/js/remote-config.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; img-src 'self' data: https:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <title>AI Assistant - Vox Amelior</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
    rel="stylesheet">

  <script src="assets/js/vendor/lucide.min.js"></script>
  <script src="assets/js/vendor/chart.umd.min.js"></script>

  <link rel="stylesheet" href="assets/css/main.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/design-tokens.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/components.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/animations.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/analyzer.css?v=2024110802">


  <!-- Vox Amelior Design System -->
  <link rel="stylesheet" href="assets/css/vox-amelior.css">
  <link rel="stylesheet" href="assets/css/nexus/nav.css">

  <!-- Page-specific styles -->
  <link rel="stylesheet" href="assets/css/pages/gemma.css">

  <!-- Emotion styles (for Emotions tab) -->
  <link rel="stylesheet" href="assets/css/pages/emotions.css">

  <script>
    window.__ASSET_VERSION__ = '2024110802';
  </script>
  <script src="assets/js/mock_data.js"></script>
  <script src="assets/js/api.js?v=2024110101"></script>
  <script src="assets/js/app.js?v=2024110101"></script>
  <script src="assets/js/auth.js?v=2024110101"></script>
  <script src="assets/js/gemma_analyzer_ui.js?v=2024110802"></script>
  <script src="assets/js/database_viewer.js?v=2024110802"></script>

  <!-- Chart.js for Emotions tab -->

  <!-- Quality Intelligence Module (self-contained 3D dashboard) -->
  <script src="assets/js/quality_intelligence.js?v=2024122601"></script>

  <script src="assets/js/offline-banner.js"></script>
</head>


<body class="gemma-theme">

  <!-- Navigation (Vox Amelior) -->
  <div class="demo-banner">
    <strong>DEMO MODE:</strong> Static Data Simulation
  </div>
  <style>
    .demo-banner {
      background: linear-gradient(90deg, #FF6B6B, #FF8E53);
      color: #fff;
      text-align: center;
      padding: 8px;
      font-size: 0.9rem;
      font-weight: bold;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 99999;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    body {
      margin-top: 40px !important;
    }

    .vox-nav {
      top: 40px !important;
    }
  </style>
  <nav class="vox-nav">
    <div class="vox-nav-inner">
      <a href="index.html" class="vox-logo">
        <div class="vox-logo-mark">
          <img src="assets/images/logo.png" alt="Vox Amelior Logo">
        </div>
        <span class="vox-logo-text">Vox Amelior</span>
      </a>

      <button class="vox-nav-toggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <div class="vox-nav-links">
        <a href="index.html#features" class="vox-nav-link">Features</a>
        <a href="gemma.html" class="vox-nav-link active">AI Assistant</a>
        <a href="nexus.html" class="vox-nav-link">Analytics</a>

        <!-- Enterprise Dropdown -->
        <div class="vox-nav-dropdown">
          <button class="vox-nav-link">
            Enterprise
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div class="vox-nav-dropdown-menu">
            <a href="enterprise/index.html" class="dropdown-item">
              <span class="icon">&#127970;</span>
              <div class="text">
                <span class="title">Overview</span>
                <span class="desc">Enterprise solutions hub</span>
              </div>
            </a>
            <a href="enterprise/salesforce/index.html" class="dropdown-item">
              <span class="icon">&#9729;</span>
              <div class="text">
                <span class="title">Salesforce CRM</span>
                <span class="desc">CRM intelligence integration</span>
              </div>
            </a>
            <a href="enterprise/fiserv/index.html" class="dropdown-item">
              <span class="icon">&#127974;</span>
              <div class="text">
                <span class="title">Fiserv Banking</span>
                <span class="desc">Financial services platform</span>
              </div>
            </a>
          </div>
        </div>

        <!-- Portfolio Link (visible in mobile menu) -->
        <a href="https://whyhirepruitt.dev" class="vox-nav-link mobile-portfolio-link">Return to Portfolio</a>
      </div>

      <div class="nav-cta-container">
        <!-- Sign In Removed -->
        <a href="https://whyhirepruitt.dev" class="vox-btn vox-btn-primary"
          style="flex-grow: 1; text-align: center; min-width: 200px;">Return to Portfolio Page</a>
      </div>
    </div>
  </nav>

  <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
    <div class="gemma-shell">

      <section class="fade-in-up" style="text-align: center; margin-bottom: 2rem;">
        <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Gemma AI Insights</h1>
        <p class="text-muted">GPU-accelerated analysis with personality detection & summarization</p>
      </section>

      <!-- Tabbed Interface -->
      <section class="fade-in-up delay-100" style="margin-bottom: 1.5rem;">
        <div class="gemma-tabs">
          <button class="gemma-tab active" data-tab="chat">
            <i data-lucide="message-circle" style="width: 18px; height: 18px;"></i>
            Chat
          </button>
          <button class="gemma-tab" data-tab="transcripts">
            <i data-lucide="file-text" style="width: 18px; height: 18px;"></i>
            Transcriptions
          </button>
          <button class="gemma-tab" data-tab="emotions">
            <i data-lucide="smile" style="width: 18px; height: 18px;"></i>
            Emotions
          </button>
          <button class="gemma-tab" data-tab="search">
            <i data-lucide="search" style="width: 18px; height: 18px;"></i>
            Search
          </button>
          <button class="gemma-tab" data-tab="databases">
            <i data-lucide="database" style="width: 18px; height: 18px;"></i>
            Databases
          </button>
        </div>
      </section>

      <!-- ============================================ -->
      <!-- Tab Content: Analytics                       -->
      <!-- ============================================ -->
      <div id="tab-analytics" class="gemma-tab-content" style="display:none;">

        <section class="gemma-period-filter fade-in-up delay-150">
          <div class="chip-group chip-group-center" id="gemma-period-chips">
            <button type="button" class="chip-toggle" data-gemma-period="today">Today</button>
            <button type="button" class="chip-toggle" data-gemma-period="week">This Week</button>
            <button type="button" class="chip-toggle" data-gemma-period="month">This Month</button>
            <button type="button" class="chip-toggle" data-gemma-period="all">All Time</button>
          </div>
        </section>

        <section class="gemma-stat-grid fade-in-up delay-200" id="gemma-stat-grid">
          <div class="gemma-stat-card" style="--stat-accent:var(--emotion-joy);">
            <div class="stat-icon">
              <i data-lucide="smile" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-joy-count">0</div>
            <div class="stat-label">Joy Detected</div>
            <div class="stat-hint">Updated from analytics</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:var(--emotion-anger);">
            <div class="stat-icon">
              <i data-lucide="frown" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-negative-count">0</div>
            <div class="stat-label">Negative Signals</div>
            <div class="stat-hint">Anger ‚Ä¢ Fear ‚Ä¢ Sadness ‚Ä¢ Disgust</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:#7c3aed;">
            <div class="stat-icon">
              <i data-lucide="activity" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-total-analyzed">0</div>
            <div class="stat-label">Total Segments</div>
            <div class="stat-hint" id="gemma-period-label">Selected range</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:#38bdf8;">
            <div class="stat-icon">
              <i data-lucide="wind" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-avg-pace">0</div>
            <div class="stat-label">Avg Pace (WPM)</div>
            <div class="stat-hint">Speech overlay</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:#fbbf24;">
            <div class="stat-icon">
              <i data-lucide="audio-lines" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-avg-pitch">0</div>
            <div class="stat-label">Avg Pitch (Hz)</div>
            <div class="stat-hint">Speech overlay</div>
          </div>
        </section>

        <section class="glass-card gemma-filter-panel fade-in-up delay-250">
          <div class="gemma-filter-grid">
            <div class="gemma-filter-column">
              <div class="chip-panel-header">
                <h4>Emotion Layers</h4>
                <button type="button" class="chip-toggle chip-all" id="gemma-emotion-all">All</button>
              </div>
              <div class="chip-group" id="gemma-emotion-chips"></div>
            </div>
            <div class="gemma-filter-column">
              <div class="chip-panel-header">
                <h4>Speech Overlays</h4>
                <button type="button" class="chip-toggle chip-all" id="gemma-metric-all">All</button>
              </div>
              <div class="chip-group" id="gemma-metric-chips"></div>
            </div>
          </div>
          <div class="gemma-confidence-control">
            <div class="chip-panel-header">
              <h4>Emotion Confidence Baseline</h4>
              <span id="gemma-confidence-label">70%</span>
            </div>
            <div class="gemma-confidence-slider">
              <input type="range" min="50" max="100" step="5" value="70" id="gemma-confidence-range">
            </div>
            <p class="gemma-confidence-hint">Used whenever transcripts do not include explicit emotion confidence
              scores.
            </p>
          </div>
        </section>

        <!-- Chat Interface removed; use analyzer chat drawer (bottom/overlay) to avoid cramped layout. -->

        <!-- Advanced Analysis Section -->
        <section class="fade-in-up delay-300" style="margin-top: 2rem;">
          <div class="glass-card">
            <div
              style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; cursor: pointer;"
              onclick="toggleAdvancedAnalysis()">
              <h3 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                <i data-lucide="brain" style="width: 24px; height: 24px; color: var(--primary);"></i>
                Advanced Conversation Analysis
              </h3>
              <i data-lucide="chevron-down" id="analysis-toggle-icon"
                style="width: 20px; height: 20px; transition: transform 0.3s;"></i>
            </div>

            <div id="advanced-analysis-content" style="display: block;">
              <p class="text-muted" style="margin-bottom: 1.5rem;">
                Analyze conversations for patterns, fallacies, emotional triggers. Customize the analysis prompt and
                filters.
              </p>
              <div id="gemma-advanced-analyzer"></div>
            </div>
          </div>
      </div>
      </section>

    </div><!-- End Analytics Tab -->

    <!-- ============================================ -->
    <!-- Tab Content: Chat                            -->
    <!-- ============================================ -->
    <div id="tab-chat" class="gemma-tab-content active">
      <div class="glass-card">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="message-circle" style="width: 24px; height: 24px; color: var(--primary);"></i>
          Chat with Gemma
        </h3>
        <p class="text-muted" style="margin-bottom: 1.5rem;">
          Ask questions about your transcripts, get summaries, or have a conversation with the AI.
        </p>

        <div class="chat-interface">
          <!-- Active Database Indicator -->
          <div id="active-db-indicator" class="active-db-indicator" style="display: none;">
            <i data-lucide="database" style="width: 16px; height: 16px; color: var(--primary);"></i>
            <span class="db-name">No database selected</span>
            <span class="db-badge">RAG Mode</span>
            <button class="btn-clear-db" onclick="clearActiveDatabase()" title="Clear database">√ó</button>
          </div>
          <div class="chat-messages-area" id="chat-messages">
            <div class="chat-message-row">
              <div class="chat-avatar-icon ai-avatar">
                <i data-lucide="bot" style="width: 18px; height: 18px; color: white;"></i>
              </div>
              <div class="chat-bubble-content ai-bubble">
                Hello! I'm Gemma, your AI assistant. I can help you analyze conversations, summarize transcripts, detect
                emotions, and answer questions about your data. What would you like to know?
              </div>
            </div>
          </div>

          <div class="chat-input-row">
            <input type="text" id="chat-input" class="glass-input" placeholder="Type your message..." style="flex: 1;">
            <button class="btn btn-primary" onclick="sendChatMessage()">
              <i data-lucide="send" style="width: 18px; height: 18px;"></i>
              Send
            </button>
          </div>
        </div>
      </div>

      <!-- Quick Prompts -->
      <div class="glass-card" style="margin-top: 1.5rem;">
        <h4 style="margin-bottom: 1rem;">Quick Prompts</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
          <button class="chip-toggle" onclick="useQuickPrompt('Summarize my conversations from today')">üìù Today's
            Summary</button>
          <button class="chip-toggle" onclick="useQuickPrompt('What emotions were most common this week?')">üòä Emotion
            Analysis</button>
          <button class="chip-toggle" onclick="useQuickPrompt('What topics come up most frequently?')">üîç Topic
            Trends</button>
          <button class="chip-toggle" onclick="useQuickPrompt('Analyze the personality traits in my conversations')">üë§
            Personality</button>
        </div>
      </div>
    </div><!-- End Chat Tab -->

    <!-- ============================================ -->
    <!-- Tab Content: Transcriptions                  -->
    <!-- ============================================ -->
    <div id="tab-transcripts" class="gemma-tab-content">
      <div class="glass-card">
        <!-- Header with View Mode Toggle -->
        <div
          style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem;">
          <h3 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="file-text" style="width: 24px; height: 24px; color: var(--primary);"></i>
            Transcription Analysis
          </h3>
          <!-- View Mode Toggle -->
          <div class="excel-view-toggle"
            style="display: flex; gap: 0.25rem; background: rgba(0,82,204,0.05); border-radius: 0.5rem; padding: 0.25rem;">
            <button type="button" class="view-mode-btn active" data-mode="standard"
              onclick="toggleTranscriptViewMode('standard')" title="Card View">
              <i data-lucide="layout-grid" style="width: 16px; height: 16px;"></i> Cards
            </button>
            <button type="button" class="view-mode-btn" data-mode="excel" onclick="toggleTranscriptViewMode('excel')"
              title="Excel Grid View">
              <i data-lucide="table" style="width: 16px; height: 16px;"></i> Excel
            </button>
          </div>
        </div>
        <p class="text-muted" style="margin-bottom: 1rem;">
          Browse transcripts with emotion filtering and AI-powered insights.
        </p>

        <!-- Emotion Filter Chips (shared between views) -->
        <div class="chip-toolbar" style="margin-bottom: 1rem;">
          <div class="chip-group" id="transcript-emotion-filters">
            <button type="button" class="chip-toggle chip-all active" data-emotion="all"
              onclick="filterTranscriptsByEmotion('all')">All</button>
            <button type="button" class="chip-toggle" data-emotion="joy" onclick="filterTranscriptsByEmotion('joy')"
              style="border-color: #10b981;">üòä Joy</button>
            <button type="button" class="chip-toggle" data-emotion="anger" onclick="filterTranscriptsByEmotion('anger')"
              style="border-color: #ef4444;">üò† Anger</button>
            <button type="button" class="chip-toggle" data-emotion="sadness"
              onclick="filterTranscriptsByEmotion('sadness')" style="border-color: #3b82f6;">üò¢ Sadness</button>
            <button type="button" class="chip-toggle" data-emotion="fear" onclick="filterTranscriptsByEmotion('fear')"
              style="border-color: #8b5cf6;">üò∞ Fear</button>
            <button type="button" class="chip-toggle" data-emotion="neutral"
              onclick="filterTranscriptsByEmotion('neutral')" style="border-color: #6b7280;">üòê Neutral</button>
          </div>
        </div>

        <!-- Transcript Navigation (for detail view) -->
        <div class="transcript-nav" id="transcript-nav" style="display: none;">
          <button class="transcript-nav-btn" onclick="navigateTranscript('prev')" id="prev-transcript-btn" disabled>
            <i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i> Previous
          </button>
          <span id="transcript-position">1 of 1</span>
          <button class="transcript-nav-btn" onclick="navigateTranscript('next')" id="next-transcript-btn" disabled>
            Next <i data-lucide="chevron-right" style="width: 16px; height: 16px;"></i>
          </button>
          <button class="transcript-nav-btn" onclick="returnToTranscriptList()" style="margin-left: auto;">
            <i data-lucide="list" style="width: 16px; height: 16px;"></i> Back to List
          </button>
        </div>

        <!-- Transcript Content Container -->
        <div id="transcript-content">
          <!-- STANDARD VIEW: Card List (Default) -->
          <div id="transcript-list" class="transcript-list">
            <div class="skeleton" style="height: 60px; margin-bottom: 0.5rem;"></div>
            <div class="skeleton" style="height: 60px; margin-bottom: 0.5rem;"></div>
            <div class="skeleton" style="height: 60px;"></div>
          </div>

          <!-- EXCEL VIEW: Spreadsheet Grid (Hidden by default) -->
          <div id="excel-transcript-grid" class="excel-grid" style="display: none;">
            <!-- Excel Toolbar -->
            <div class="excel-toolbar">
              <div class="excel-search-wrapper">
                <i data-lucide="search" style="width: 16px; height: 16px; color: #5a6a7f;"></i>
                <input type="text" id="excel-quick-filter" class="excel-search"
                  placeholder="Quick filter all columns..." oninput="filterExcelGrid(this.value)">
              </div>
              <div class="excel-toolbar-actions">
                <span id="excel-row-count" class="excel-row-count">0 transcripts</span>
                <button type="button" class="excel-btn" onclick="exportTranscriptsCSV()">
                  <i data-lucide="download" style="width: 14px; height: 14px;"></i> Export CSV
                </button>
              </div>
            </div>

            <!-- Excel Table -->
            <div class="excel-table-wrapper">
              <table class="excel-table" id="excel-transcript-table">
                <thead class="excel-header">
                  <tr>
                    <th class="excel-th sortable" data-sort="created_at" onclick="sortExcelColumn('created_at')">
                      <span>Date</span><span class="sort-icon">‚Üï</span>
                    </th>
                    <th class="excel-th sortable" data-sort="speaker" onclick="sortExcelColumn('speaker')">
                      <span>Speaker</span><span class="sort-icon">‚Üï</span>
                    </th>
                    <th class="excel-th sortable" data-sort="duration" onclick="sortExcelColumn('duration')">
                      <span>Duration</span><span class="sort-icon">‚Üï</span>
                    </th>
                    <th class="excel-th sortable" data-sort="emotion" onclick="sortExcelColumn('emotion')">
                      <span>Emotion</span><span class="sort-icon">‚Üï</span>
                    </th>
                    <th class="excel-th" style="min-width: 300px;">Preview</th>
                    <th class="excel-th" style="width: 100px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="excel-transcript-body">
                  <!-- Rows populated by JS -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Detail Viewer (shared) -->
          <div id="transcript-viewer" class="transcript-viewer"
            style="display: none; max-height: 400px; overflow-y: auto;"></div>
        </div>
      </div>

      <!-- Summary & Insights Panel -->
      <div class="glass-card" style="margin-top: 1.5rem;" id="transcript-insights-panel" style="display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
          <h4 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="sparkles" style="width: 20px; height: 20px; color: var(--primary);"></i>
            Summary & Insights
          </h4>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-ghost btn-sm" onclick="generateTranscriptSummary()" id="generate-summary-btn">
              <i data-lucide="wand-2" style="width: 14px; height: 14px;"></i>
              Generate Summary
            </button>
            <button class="btn btn-primary btn-sm" onclick="saveTranscriptNotes()" id="save-notes-btn">
              <i data-lucide="save" style="width: 14px; height: 14px;"></i>
              Save
            </button>
          </div>
        </div>

        <!-- User Notes -->
        <div style="margin-bottom: 1rem;">
          <label style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">
            Your Notes (saved per transcript)
          </label>
          <textarea id="transcript-notes" class="glass-input" rows="3"
            placeholder="Add your notes about this transcript..." style="width: 100%; resize: vertical;"></textarea>
        </div>

        <!-- AI-Generated Insights -->
        <div id="ai-insights" style="display: none;">
          <label style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">
            AI-Generated Summary
          </label>
          <div id="ai-insights-content"
            style="background: rgba(0, 82, 204, 0.03); border-radius: 0.75rem; padding: 1rem; line-height: 1.6;">
            <!-- AI insights will appear here -->
          </div>
        </div>

        <!-- Key Metrics -->
        <div class="stat-grid" style="margin-top: 1rem;" id="transcript-metrics">
          <div class="stat-card hover-lift" style="padding: 0.75rem;">
            <div class="stat-value" id="metric-segments" style="font-size: 1.5rem;">-</div>
            <div class="stat-label" style="font-size: 0.75rem;">Segments</div>
          </div>
          <div class="stat-card hover-lift" style="padding: 0.75rem;">
            <div class="stat-value" id="metric-speakers" style="font-size: 1.5rem;">-</div>
            <div class="stat-label" style="font-size: 0.75rem;">Speakers</div>
          </div>
          <div class="stat-card hover-lift" style="padding: 0.75rem;">
            <div class="stat-value" id="metric-duration" style="font-size: 1.5rem;">-</div>
            <div class="stat-label" style="font-size: 0.75rem;">Duration</div>
          </div>
          <div class="stat-card hover-lift" style="padding: 0.75rem;">
            <div class="stat-value" id="metric-emotion" style="font-size: 1.5rem;">-</div>
            <div class="stat-label" style="font-size: 0.75rem;">Dominant</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- Tab Content: Emotions                        -->
    <!-- ============================================ -->
    <div id="tab-emotions" class="gemma-tab-content" data-emotions-container>

      <!-- Period Filter -->
      <div class="chip-toolbar" style="margin-bottom: 1.5rem;">
        <div class="chip-group" id="emotions-period-chips">
          <button type="button" class="chip-toggle active" data-period="today"
            onclick="filterEmotionsPeriod('today')">Today</button>
          <button type="button" class="chip-toggle" data-period="week" onclick="filterEmotionsPeriod('week')">This
            Week</button>
          <button type="button" class="chip-toggle" data-period="month" onclick="filterEmotionsPeriod('month')">This
            Month</button>
          <button type="button" class="chip-toggle" data-period="all" onclick="filterEmotionsPeriod('all')">All
            Time</button>
        </div>
      </div>

      <!-- Top Row: Radar + Speaker Insights -->
      <section class="grid grid-2" style="margin-bottom: 1.5rem; gap: 1.5rem;">
        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Speech Pattern Radar</h4>
          <div style="height: 220px;">
            <canvas id="speech-radar-chart"></canvas>
          </div>
        </div>
        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Speaker Insights</h4>
          <div style="max-height: 220px; overflow-y: auto;">
            <table style="width: 100%; font-size: 0.85rem;">
              <thead>
                <tr style="text-align: left; color: var(--text-secondary);">
                  <th style="padding: 0.5rem;">Speaker</th>
                  <th>Segments</th>
                  <th>Emotion</th>
                  <th>Pace</th>
                  <th>Pitch</th>
                </tr>
              </thead>
              <tbody id="speaker-table-body">
                <tr>
                  <td colspan="5" class="text-muted">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Stat Cards -->
      <section class="stat-grid" style="margin-bottom: 1.5rem;">
        <div class="stat-card hover-lift">
          <i data-lucide="smile" style="width: 28px; height: 28px; color: var(--success); margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="stat-joy">0</div>
          <div class="stat-label">Joy Detected</div>
        </div>
        <div class="stat-card hover-lift">
          <i data-lucide="frown" style="width: 28px; height: 28px; color: var(--danger); margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="stat-negative">0</div>
          <div class="stat-label">Negative</div>
        </div>
        <div class="stat-card hover-lift">
          <i data-lucide="activity"
            style="width: 28px; height: 28px; color: var(--primary); margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">Analyzed</div>
        </div>
        <div class="stat-card hover-lift">
          <i data-lucide="gauge" style="width: 28px; height: 28px; color: #3b82f6; margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="stat-pace">-</div>
          <div class="stat-label">Avg Pace</div>
        </div>
        <div class="stat-card hover-lift">
          <i data-lucide="audio-lines" style="width: 28px; height: 28px; color: #f59e0b; margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="stat-pitch">-</div>
          <div class="stat-label">Avg Pitch</div>
        </div>
      </section>

      <!-- Charts -->
      <section class="grid grid-2" style="gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Emotion Distribution</h4>
          <div style="height: 250px;">
            <canvas id="emotion-distribution-chart"></canvas>
          </div>
        </div>
        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Emotion Timeline</h4>
          <div style="height: 250px;">
            <canvas id="emotion-trend-chart"></canvas>
          </div>
        </div>
      </section>

      <!-- Emotional Moments Feed -->
      <section class="glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="margin: 0;">Recent Emotional Moments</h4>
          <div class="chip-group" id="moment-emotion-filter">
            <button type="button" class="chip-toggle chip-all active" data-emotion="all"
              onclick="filterMomentEmotion('all')">All</button>
            <button type="button" class="chip-toggle" data-emotion="joy"
              onclick="filterMomentEmotion('joy')">üòä</button>
            <button type="button" class="chip-toggle" data-emotion="anger"
              onclick="filterMomentEmotion('anger')">üò†</button>
            <button type="button" class="chip-toggle" data-emotion="sadness"
              onclick="filterMomentEmotion('sadness')">üò¢</button>
          </div>
        </div>
        <div id="emotion-moment-feed" style="max-height: 400px; overflow-y: auto;">
          <div class="skeleton" style="height: 80px; margin-bottom: 1rem;"></div>
          <div class="skeleton" style="height: 80px; margin-bottom: 1rem;"></div>
          <div class="skeleton" style="height: 80px;"></div>
        </div>
      </section>

      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="emotions.html" class="vox-btn vox-btn-ghost">Open Full Emotions Dashboard ‚Üí</a>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- Tab Content: Search                          -->
    <!-- ============================================ -->
    <div id="tab-search" class="gemma-tab-content">
      <div class="glass-card">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="search" style="width: 24px; height: 24px; color: var(--primary);"></i>
          Semantic Search
        </h3>
        <p class="text-muted" style="margin-bottom: 1.5rem;">
          Search across all your transcripts using natural language.
        </p>

        <div class="search-container">
          <div class="search-input-wrapper">
            <i data-lucide="search" class="search-icon" style="width: 20px; height: 20px;"></i>
            <input type="text" id="semantic-search-input" placeholder="Search transcripts..."
              onkeypress="if(event.key==='Enter') performSemanticSearch()">
          </div>

          <div id="search-results" class="search-results">
            <p class="text-muted" style="text-align: center; padding: 2rem;">
              Enter a search query to find relevant segments in your transcripts.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- Tab Content: Databases                       -->
    <!-- ============================================ -->
    <div id="tab-databases" class="gemma-tab-content">
      <!-- Upload Section -->
      <div class="glass-card">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="database" style="width: 24px; height: 24px; color: var(--primary);"></i>
          Custom Database Upload
        </h3>
        <p class="text-muted" style="margin-bottom: 1.5rem;">
          Upload CSV files to add custom data for AI analysis. The data will be vectorized and available for RAG
          queries.
        </p>

        <div class="db-upload-zone" id="db-upload-zone" onclick="document.getElementById('db-file-input').click()">
          <i data-lucide="upload-cloud" class="db-upload-icon"></i>
          <h4>Drop CSV files here or click to upload</h4>
          <p class="text-muted" style="margin-top: 0.5rem;">Supports CSV format ‚Ä¢ Max 50MB per file</p>
          <input type="file" id="db-file-input" accept=".csv" multiple style="display: none;"
            onchange="handleDatabaseUpload(event)">
        </div>

        <div class="db-file-list" id="db-file-list">
          <!-- Files will be listed here -->
        </div>
      </div>

      <!-- ============================================ -->
      <!-- Sample Database Preview                     -->
      <!-- ============================================ -->
      <div class="glass-card" style="margin-top: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="table-2" style="width: 24px; height: 24px; color: var(--primary);"></i>
            Sample Database: customer_conversations.csv
            <span
              style="background: rgba(99, 102, 241, 0.15); color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 500;">8
              rows</span>
          </h4>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span
              style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.35rem;">
              <i data-lucide="sparkles" style="width: 12px; height: 12px;"></i>
              3 Analyzed by Gemma
            </span>
          </div>
        </div>

        <style>
          .demo-db-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
          }

          .demo-db-table th {
            background: rgba(99, 102, 241, 0.08);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid rgba(99, 102, 241, 0.2);
          }

          .demo-db-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            color: var(--text-secondary);
          }

          .demo-db-table tr:hover {
            background: rgba(99, 102, 241, 0.03);
          }

          .demo-db-table tr.gemma-analyzed {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.08) 0%, rgba(52, 211, 153, 0.04) 100%);
            border-left: 3px solid #10b981;
          }

          .demo-db-table tr.gemma-analyzed td:first-child {
            padding-left: calc(1rem - 3px);
          }

          .gemma-badge {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            animation: gemma-pulse 2s ease-in-out infinite;
          }

          @keyframes gemma-pulse {

            0%,
            100% {
              box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.3);
            }

            50% {
              box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }
          }

          .sentiment-positive {
            color: #10b981;
            font-weight: 500;
          }

          .sentiment-negative {
            color: #ef4444;
            font-weight: 500;
          }

          .sentiment-neutral {
            color: #6b7280;
            font-weight: 500;
          }
        </style>

        <div style="overflow-x: auto; border-radius: 0.5rem; border: 1px solid rgba(0,0,0,0.08);">
          <table class="demo-db-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Customer</th>
                <th>Conversation Snippet</th>
                <th>Date</th>
                <th>Sentiment</th>
                <th>Gemma Analysis</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1001</td>
                <td>John Miller</td>
                <td>Can you help me understand my billing statement?</td>
                <td>2024-12-28</td>
                <td class="sentiment-neutral">Neutral</td>
                <td>-</td>
              </tr>
              <tr>
                <td>1002</td>
                <td>Sarah Thompson</td>
                <td>I have been waiting for 3 days with no response!</td>
                <td>2024-12-28</td>
                <td class="sentiment-negative">Negative</td>
                <td>-</td>
              </tr>
              <tr class="gemma-analyzed">
                <td>1003</td>
                <td>Michael Chen</td>
                <td>Your support team was incredibly helpful today.</td>
                <td>2024-12-29</td>
                <td class="sentiment-positive">Positive</td>
                <td><span class="gemma-badge"><i data-lucide="sparkles" style="width: 10px; height: 10px;"></i>
                    Analyzed</span></td>
              </tr>
              <tr>
                <td>1004</td>
                <td>Emily Davis</td>
                <td>Is there a way to upgrade my plan?</td>
                <td>2024-12-29</td>
                <td class="sentiment-neutral">Neutral</td>
                <td>-</td>
              </tr>
              <tr class="gemma-analyzed">
                <td>1005</td>
                <td>Robert Wilson</td>
                <td>The new feature update is exactly what I needed!</td>
                <td>2024-12-30</td>
                <td class="sentiment-positive">Positive</td>
                <td><span class="gemma-badge"><i data-lucide="sparkles" style="width: 10px; height: 10px;"></i>
                    Analyzed</span></td>
              </tr>
              <tr>
                <td>1006</td>
                <td>Jennifer Lee</td>
                <td>When will the mobile app be available?</td>
                <td>2024-12-30</td>
                <td class="sentiment-neutral">Neutral</td>
                <td>-</td>
              </tr>
              <tr class="gemma-analyzed">
                <td>1007</td>
                <td>David Martinez</td>
                <td>I am extremely disappointed with the service quality.</td>
                <td>2024-12-31</td>
                <td class="sentiment-negative">Negative</td>
                <td><span class="gemma-badge"><i data-lucide="sparkles" style="width: 10px; height: 10px;"></i>
                    Analyzed</span></td>
              </tr>
              <tr>
                <td>1008</td>
                <td>Amanda Brown</td>
                <td>Thank you for the quick resolution!</td>
                <td>2024-12-31</td>
                <td class="sentiment-positive">Positive</td>
                <td>-</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div
          style="margin-top: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.08); border-radius: 0.5rem; border-left: 3px solid #10b981;">
          <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
            <i data-lucide="info"
              style="width: 18px; height: 18px; color: #10b981; flex-shrink: 0; margin-top: 2px;"></i>
            <div>
              <strong style="color: #059669;">Gemma Analysis Summary</strong>
              <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem; line-height: 1.5;">
                Analyzed 3 of 8 rows (37.5%). Detected patterns: <strong>1 escalation risk</strong> (ID 1007),
                <strong>2 high satisfaction</strong> (IDs 1003, 1005). Recommendation: Prioritize follow-up with David
                Martinez.
              </p>
            </div>
          </div>
        </div>
      </div>
      <!-- ============================================ -->
      <!-- Gemma Quality Analysis Panel                -->
      <!-- ============================================ -->
      <div id="quality-analysis-panel" class="glass-card" style="margin-top: 1.5rem; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h4 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="sparkles" style="width: 24px; height: 24px; color: var(--primary);"></i>
            Quality Analysis
          </h4>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <select id="scoring-row-range" class="btn btn-ghost btn-sm" style="padding: 0.375rem 0.75rem;"
              title="Which portion of the database to score">
              <option value="full">Full Database</option>
              <option value="last_10pct">Last 10%</option>
              <option value="last_25pct" selected>Last 25%</option>
              <option value="last_50pct">Last 50%</option>
              <option value="last_1000">Last 1,000 rows</option>
              <option value="last_10000">Last 10,000 rows</option>
              <option value="last_100000">Last 100,000 rows</option>
            </select>
            <select id="scoring-chunk-size" class="btn btn-ghost btn-sm" style="padding: 0.375rem 0.75rem;"
              title="Rows per Gemma call">
              <option value="1">1 row/chunk</option>
              <option value="5">5 rows/chunk</option>
              <option value="20" selected>20 rows/chunk</option>
              <option value="100">100 rows/chunk</option>
              <option value="1000">1,000 rows/chunk</option>
              <option value="5000">5,000 rows/chunk</option>
              <option value="10000">10,000 rows/chunk</option>
              <option value="25000">25,000 rows/chunk</option>
              <option value="100000">100,000 rows/chunk</option>
            </select>
            <button id="btn-test-scoring" class="btn btn-ghost btn-sm" onclick="startQualityAnalysis(true)">
              <i data-lucide="beaker" style="width: 14px; height: 14px;"></i> Test
            </button>
            <button id="btn-start-scoring" class="btn btn-primary btn-sm" onclick="startQualityAnalysis(false)">
              <i data-lucide="play" style="width: 14px; height: 14px;"></i> Analyze
            </button>
          </div>
        </div>

        <!-- Progress Section (hidden until started) -->
        <div id="scoring-progress-section" style="display: none;">
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 2rem; align-items: center;">
            <!-- Circular Progress Ring -->
            <div style="position: relative; width: 120px; height: 120px;">
              <svg class="scoring-progress-ring" viewBox="0 0 120 120" style="transform: rotate(-90deg);">
                <circle cx="60" cy="60" r="54" stroke="var(--border-color)" stroke-width="8" fill="none" />
                <circle id="scoring-progress-circle" cx="60" cy="60" r="54" stroke="url(#progress-gradient)"
                  stroke-width="8" fill="none" stroke-dasharray="339.29" stroke-dashoffset="339.29"
                  stroke-linecap="round" style="transition: stroke-dashoffset 0.5s ease;" />
                <defs>
                  <linearGradient id="progress-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#6366f1" />
                    <stop offset="100%" stop-color="#a855f7" />
                  </linearGradient>
                </defs>
              </svg>
              <div
                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div id="scoring-percent" style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">0%
                </div>
              </div>
            </div>

            <!-- Stats Grid -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
              <div style="background: var(--card-bg); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                <div id="scoring-chunks-done" style="font-size: 1.25rem; font-weight: 600; color: var(--primary);">0
                </div>
                <div id="scoring-chunks-total" style="font-size: 0.75rem; color: var(--text-muted);">/ 0 chunks</div>
              </div>
              <div style="background: var(--card-bg); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                <div id="scoring-eta" style="font-size: 1.25rem; font-weight: 600; color: var(--warning);">--</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">ETA</div>
              </div>
              <div style="background: var(--card-bg); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                <div id="scoring-avg" style="font-size: 1.25rem; font-weight: 600; color: var(--success);">--</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">Avg Score</div>
              </div>
            </div>
          </div>

          <div id="scoring-status-text"
            style="margin-top: 1rem; padding: 0.75rem; background: var(--card-bg); border-radius: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
            <i data-lucide="loader" class="scoring-spinner"
              style="width: 14px; height: 14px; animation: spin 1s linear infinite; margin-right: 0.5rem;"></i>
            <span>Initializing...</span>
          </div>
        </div>

        <!-- Results Section (hidden until complete) -->
        <div id="scoring-results-section" style="display: none;">
          <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
            <div class="score-card" data-dimension="completeness">
              <div class="score-value">--</div>
              <div class="score-label">Completeness</div>
              <div class="score-bar">
                <div class="score-fill"></div>
              </div>
            </div>
            <div class="score-card" data-dimension="accuracy">
              <div class="score-value">--</div>
              <div class="score-label">Accuracy</div>
              <div class="score-bar">
                <div class="score-fill"></div>
              </div>
            </div>
            <div class="score-card" data-dimension="consistency">
              <div class="score-value">--</div>
              <div class="score-label">Consistency</div>
              <div class="score-bar">
                <div class="score-fill"></div>
              </div>
            </div>
            <div class="score-card" data-dimension="relevance">
              <div class="score-value">--</div>
              <div class="score-label">Relevance</div>
              <div class="score-bar">
                <div class="score-fill"></div>
              </div>
            </div>
            <div class="score-card" data-dimension="overall"
              style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white;">
              <div class="score-value">--</div>
              <div class="score-label">Overall</div>
              <div class="score-bar" style="background: rgba(255,255,255,0.3);">
                <div class="score-fill" style="background: white;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quality Intelligence Dashboard is dynamically injected by quality_intelligence.js -->


      <!-- ============================================ -->
      <!-- Excel-Like Database Viewer                   -->
      <!-- ============================================ -->
      <div id="database-excel-viewer" class="glass-card database-excel-viewer"
        style="margin-top: 1.5rem; display: none;">
        <!-- Viewer Header -->
        <div
          style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem;">
          <h4 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="table" style="width: 20px; height: 20px; color: var(--primary);"></i>
            <span id="db-viewer-title">Database Preview</span>
          </h4>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <button class="btn btn-ghost btn-sm" onclick="DatabaseViewer.hide()" title="Close viewer">
              <i data-lucide="x" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
        </div>

        <!-- Excel Grid Container -->
        <div class="excel-grid">
          <!-- Toolbar -->
          <div class="excel-toolbar">
            <div class="excel-search-wrapper">
              <i data-lucide="search" style="width: 16px; height: 16px; color: #5a6a7f;"></i>
              <input type="text" id="db-excel-filter" class="excel-search" placeholder="Search all columns..."
                oninput="DatabaseViewer.search(this.value)">
            </div>
            <div class="excel-toolbar-actions">
              <span id="db-excel-row-count" class="excel-row-count">0 rows</span>
              <button type="button" class="excel-btn" onclick="DatabaseViewer.exportCSV()" title="Export current page">
                <i data-lucide="download" style="width: 14px; height: 14px;"></i> Export Page
              </button>
              <button type="button" class="excel-btn btn-primary" onclick="DatabaseViewer.exportAllCSV()"
                title="Download complete file">
                <i data-lucide="file-down" style="width: 14px; height: 14px;"></i> Export All
              </button>
            </div>
          </div>

          <!-- Table -->
          <div class="excel-table-wrapper">
            <table class="excel-table" id="db-excel-table">
              <thead class="excel-header">
                <tr id="db-excel-header-row">
                  <!-- Headers populated by JS -->
                </tr>
              </thead>
              <tbody id="db-excel-body">
                <!-- Rows populated by JS -->
                <tr>
                  <td colspan="10" class="excel-empty-state">
                    <i data-lucide="inbox" style="width: 48px; height: 48px;"></i>
                    <p style="margin-top: 1rem;">Upload a database to view its contents</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Pagination -->
        <div id="db-pagination" class="db-pagination" style="margin-top: 1rem;">
          <!-- Pagination controls populated by JS -->
        </div>
      </div>

      <!-- Database Info -->
      <div class="glass-card" style="margin-top: 1.5rem;">
        <h4 style="margin-bottom: 1rem;">Supported Formats</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div>
            <strong>CSV Requirements:</strong>
            <ul style="color: var(--text-secondary); font-size: 0.875rem; padding-left: 1.2rem; margin-top: 0.5rem;">
              <li>UTF-8 encoding</li>
              <li>Header row required</li>
              <li>Comma separated</li>
            </ul>
          </div>
          <div>
            <strong>Coming Soon:</strong>
            <ul style="color: var(--text-muted); font-size: 0.875rem; padding-left: 1.2rem; margin-top: 0.5rem;">
              <li>JSON support</li>
              <li>Excel (.xlsx)</li>
              <li>Parquet files</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Existing Databases (moved to bottom) -->
      <div class="glass-card" style="margin-top: 1.5rem;">
        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="folder-open" style="width: 20px; height: 20px;"></i>
          Uploaded Databases
        </h4>
        <div id="existing-databases">
          <p class="text-muted">No custom databases uploaded yet.</p>
        </div>
      </div>

    </div><!-- End Databases Tab -->

    </div><!-- End gemma-shell -->
  </main>

  <script>
    lucide.createIcons();

    const GEMMA_EMOTION_OPTIONS = [
      { key: 'anger', label: 'Anger', color: 'var(--emotion-anger)' },
      { key: 'fear', label: 'Fear', color: 'var(--emotion-fear)' },
      { key: 'joy', label: 'Joy', color: 'var(--emotion-joy)' },
      { key: 'neutral', label: 'Neutral', color: 'var(--emotion-neutral)' },
      { key: 'sadness', label: 'Sadness', color: 'var(--emotion-sadness)' },
      { key: 'surprise', label: 'Surprise', color: 'var(--emotion-surprise)' },
      { key: 'disgust', label: 'Disgust', color: 'var(--emotion-disgust)' },
    ];

    const GEMMA_METRIC_OPTIONS = [
      { key: 'pace_wpm', label: 'Pace', color: '#38bdf8' },
      { key: 'pitch_mean', label: 'Pitch', color: '#fbbf24' },
      { key: 'volume_rms', label: 'Volume', color: '#f472b6' },
      { key: 'volume_peak', label: 'Volume Peak', color: '#fb7185' },
      { key: 'pause_ms', label: 'Pauses', color: '#14b8a6' },
      { key: 'word_count', label: 'Words', color: '#facc15' },
    ];

    const GEMMA_PERIOD_LOOKBACK = { today: 0, week: 6, month: 29, all: null };
    const GEMMA_PERIOD_LABELS = { today: 'Today', week: 'This Week', month: 'This Month', all: 'All Time' };

    const gemmaInsightsState = {
      period: 'all',
      selectedEmotions: new Set(GEMMA_EMOTION_OPTIONS.map((opt) => opt.key)),
      selectedMetrics: new Set(GEMMA_METRIC_OPTIONS.map((opt) => opt.key)),
      analytics: null,
      loading: false,
    };

    // ================================================
    // Database State Management (RAG Chatbot)
    // ================================================
    let activeDatabase = null;  // {filename, displayName, columns, isReady}

    function setActiveDatabase(db) {
      activeDatabase = db;

      // Persist to localStorage for session persistence
      if (db) {
        localStorage.setItem('nemo_active_database', JSON.stringify({
          filename: db.filename,
          displayName: db.displayName,
          columns: db.columns || [],
          isReady: db.isReady
        }));
      } else {
        localStorage.removeItem('nemo_active_database');
      }

      updateDatabaseIndicator();
    }

    function clearActiveDatabase() {
      setActiveDatabase(null);
      addChatMessage('üìä Database cleared. I\'ll respond with general knowledge now.', 'ai');
    }

    function updateDatabaseIndicator() {
      const indicator = document.getElementById('active-db-indicator');
      if (!indicator) return;

      if (activeDatabase && activeDatabase.isReady) {
        indicator.style.display = 'flex';
        indicator.querySelector('.db-name').textContent = activeDatabase.displayName;
        lucide.createIcons();
      } else {
        indicator.style.display = 'none';
      }

      // Also refresh the databases list to show active state
      loadSavedDatabases();
    }

    async function restoreActiveDatabase() {
      const saved = localStorage.getItem('nemo_active_database');
      if (saved) {
        try {
          const db = JSON.parse(saved);

          // Verify the database still exists on server
          const response = await fetch('/databases', { credentials: 'include' });
          if (response.ok) {
            const data = await response.json();
            const exists = data.databases.find(d => d.filename === db.filename);

            if (exists && exists.has_embeddings) {
              activeDatabase = { ...db, isReady: true };
              updateDatabaseIndicator();
              return;
            }
          }
        } catch (e) {
          console.warn('Could not restore database session:', e);
        }

        // Clear invalid saved state
        localStorage.removeItem('nemo_active_database');
      }
    }

    const numberFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
    const GEMMA_DEFAULT_CONFIDENCE = getDefaultConfidencePercent();
    let gemmaConfidencePercent = GEMMA_DEFAULT_CONFIDENCE;
    let gemmaConfidenceSlider;
    let gemmaConfidenceLabel;

    function getDefaultConfidencePercent() {
      try {
        if (typeof window !== 'undefined' && typeof window.getEmotionConfidenceBaseline === 'function') {
          return Math.round(window.getEmotionConfidenceBaseline() * 100);
        }
      } catch (_) {
        /* noop */
      }
      return 70;
    }

    function initGemmaControls() {
      renderGemmaEmotionChips();
      renderGemmaMetricChips();
      bindGemmaPeriodChips();
      const emotionAllBtn = document.getElementById('gemma-emotion-all');
      if (emotionAllBtn) {
        emotionAllBtn.onclick = () => {
          gemmaInsightsState.selectedEmotions = new Set(GEMMA_EMOTION_OPTIONS.map((opt) => opt.key));
          renderGemmaEmotionChips();
          syncAnalyzerEmotionsFromState();
          refreshGemmaAnalytics();
        };
      }
      const metricAllBtn = document.getElementById('gemma-metric-all');
      if (metricAllBtn) {
        metricAllBtn.onclick = () => {
          gemmaInsightsState.selectedMetrics = new Set(GEMMA_METRIC_OPTIONS.map((opt) => opt.key));
          renderGemmaMetricChips();
          refreshGemmaAnalytics();
        };
      }
      initGemmaConfidenceControl();
      syncAnalyzerEmotionsFromState();
      return setGemmaPeriod('all', { force: true });
    }

    function renderGemmaEmotionChips() {
      const container = document.getElementById('gemma-emotion-chips');
      if (!container) return;
      container.innerHTML = GEMMA_EMOTION_OPTIONS.map((opt) => {
        const active = gemmaInsightsState.selectedEmotions.has(opt.key);
        return `
          <button type="button" class="chip-toggle" data-emotion="${opt.key}" aria-pressed="${active}" style="--chip-color:${opt.color};">
            ${opt.label}
          </button>
        `;
      }).join('');
      container.querySelectorAll('button[data-emotion]').forEach((btn) => {
        btn.addEventListener('click', () => toggleGemmaEmotion(btn.dataset.emotion));
      });
    }

    function renderGemmaMetricChips() {
      const container = document.getElementById('gemma-metric-chips');
      if (!container) return;
      container.innerHTML = GEMMA_METRIC_OPTIONS.map((opt) => {
        const active = gemmaInsightsState.selectedMetrics.has(opt.key);
        return `
          <button type="button" class="chip-toggle" data-metric="${opt.key}" aria-pressed="${active}" style="--chip-color:${opt.color};">
            ${opt.label}
          </button>
        `;
      }).join('');
      container.querySelectorAll('button[data-metric]').forEach((btn) => {
        btn.addEventListener('click', () => toggleGemmaMetric(btn.dataset.metric));
      });
    }

    function initGemmaConfidenceControl() {
      gemmaConfidenceSlider = document.getElementById('gemma-confidence-range');
      gemmaConfidenceLabel = document.getElementById('gemma-confidence-label');
      if (!gemmaConfidenceSlider || !gemmaConfidenceLabel) return;
      gemmaConfidenceSlider.value = gemmaConfidencePercent;
      gemmaConfidenceLabel.textContent = `${gemmaConfidencePercent}%`;
      gemmaConfidenceSlider.addEventListener('input', (event) => {
        gemmaConfidencePercent = Number(event.target.value);
        gemmaConfidenceLabel.textContent = `${gemmaConfidencePercent}%`;
        syncAnalyzerConfidence(gemmaConfidencePercent);
      });
      syncAnalyzerConfidence(gemmaConfidencePercent);
    }

    function syncAnalyzerEmotionsFromState() {
      if (typeof window === 'undefined' || typeof window.dispatchEvent !== 'function') return;
      const payload = Array.from(gemmaInsightsState.selectedEmotions || []);
      window.dispatchEvent(new CustomEvent('gemmaEmotionFiltersChanged', { detail: payload }));
    }

    function toggleGemmaEmotion(emotion) {
      if (!emotion) return;
      const set = gemmaInsightsState.selectedEmotions;
      if (set.has(emotion)) {
        set.delete(emotion);
      } else {
        set.add(emotion);
      }
      if (!set.size) {
        GEMMA_EMOTION_OPTIONS.forEach((opt) => set.add(opt.key));
      }
      renderGemmaEmotionChips();
      syncAnalyzerEmotionsFromState();
      refreshGemmaAnalytics();
    }

    function toggleGemmaMetric(metric) {
      if (!metric) return;
      const set = gemmaInsightsState.selectedMetrics;
      if (set.has(metric)) {
        set.delete(metric);
      } else {
        set.add(metric);
      }
      if (!set.size) {
        GEMMA_METRIC_OPTIONS.forEach((opt) => set.add(opt.key));
      }
      renderGemmaMetricChips();
      refreshGemmaAnalytics();
    }

    function bindGemmaPeriodChips() {
      document.querySelectorAll('[data-gemma-period]').forEach((btn) => {
        btn.addEventListener('click', () => setGemmaPeriod(btn.dataset.gemmaPeriod));
      });
    }

    function setGemmaPeriod(period, { force = false } = {}) {
      if (!period) return;
      if (!force && gemmaInsightsState.period === period) return;
      gemmaInsightsState.period = period;
      document.querySelectorAll('[data-gemma-period]').forEach((btn) => {
        const isActive = btn.dataset.gemmaPeriod === period;
        btn.setAttribute('aria-pressed', isActive);
        btn.classList.toggle('active', isActive);
      });
      return refreshGemmaAnalytics();
    }

    function setGemmaInsightsLoading(isLoading) {
      const grid = document.getElementById('gemma-stat-grid');
      gemmaInsightsState.loading = isLoading;
      if (grid) grid.classList.toggle('loading', !!isLoading);
    }

    function computeGemmaPeriodRange(period) {
      if (period === 'all') {
        return { start: null, end: null };
      }
      const lookback = GEMMA_PERIOD_LOOKBACK[period] ?? 6;
      const now = new Date();
      const end = now.toISOString().slice(0, 10);
      const startDate = new Date(now);
      startDate.setDate(startDate.getDate() - lookback);
      const start = startDate.toISOString().slice(0, 10);
      return { start, end };
    }

    async function refreshGemmaAnalytics() {
      setGemmaInsightsLoading(true);
      const { start, end } = computeGemmaPeriodRange(gemmaInsightsState.period);
      try {
        const payload = await api.getAnalyticsSignals({
          start_date: start || undefined,
          end_date: end || undefined,
          emotions: Array.from(gemmaInsightsState.selectedEmotions),
          metrics: Array.from(gemmaInsightsState.selectedMetrics),
        });
        gemmaInsightsState.analytics = payload;
        renderGemmaStatCards(payload?.summary || {});
      } catch (error) {
        console.error('[Gemma] Failed to load analytics signals', error);
        renderGemmaStatCards(null);
      } finally {
        setGemmaInsightsLoading(false);
      }
    }

    function renderGemmaStatCards(summary) {
      if (!summary) {
        setTextContent('gemma-joy-count', '‚Äî');
        setTextContent('gemma-negative-count', '‚Äî');
        setTextContent('gemma-total-analyzed', '‚Äî');
        setTextContent('gemma-avg-pace', '‚Äî');
        setTextContent('gemma-avg-pitch', '‚Äî');
        const label = document.getElementById('gemma-period-label');
        if (label) {
          const name = GEMMA_PERIOD_LABELS[gemmaInsightsState.period] || 'Selected';
          label.textContent = `${name} window`;
        }
        return;
      }
      const totals = summary?.emotion_totals || {};
      const joy = totals.joy ?? 0;
      const negative = (totals.anger || 0) + (totals.fear || 0) + (totals.sadness || 0) + (totals.disgust || 0);
      const totalAnalyzed = summary?.total_analyzed ?? 0;
      const avgPace = summary?.avg_pace_wpm ?? null;
      const avgPitch = summary?.avg_pitch_mean ?? null;

      setTextContent('gemma-joy-count', formatBigNumber(joy));
      setTextContent('gemma-negative-count', formatBigNumber(negative));
      setTextContent('gemma-total-analyzed', formatBigNumber(totalAnalyzed));
      setTextContent('gemma-avg-pace', formatMetricValue(avgPace));
      setTextContent('gemma-avg-pitch', formatMetricValue(avgPitch));

      const label = document.getElementById('gemma-period-label');
      if (label) {
        const name = GEMMA_PERIOD_LABELS[gemmaInsightsState.period] || 'Selected';
        label.textContent = `${name} window`;
      }
    }

    function setTextContent(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function formatBigNumber(value) {
      if (value === null || value === undefined) return '‚Äî';
      const num = Number(value);
      if (!Number.isFinite(num)) return '‚Äî';
      return numberFormatter.format(Math.round(num));
    }

    function formatMetricValue(value) {
      if (value === null || value === undefined) return '‚Äî';
      const num = Number(value);
      if (!Number.isFinite(num)) return '‚Äî';
      return Math.round(num);
    }

    function syncAnalyzerConfidence(percent) {
      const analyzerRoot = document.querySelector('#gemma-advanced-analyzer');
      if (!analyzerRoot || percent === null || percent === undefined) return;
      const slider = analyzerRoot.querySelector('[data-role="emotion-confidence-range"]');
      const label = analyzerRoot.querySelector('[data-role="emotion-confidence-label"]');
      if (slider) slider.value = percent;
      if (label) label.textContent = `${percent}%`;
      analyzerRoot.querySelectorAll('[data-role="emotion-pill"]').forEach((pill) => {
        if (pill) pill.textContent = `${percent}%`;
      });
    }

    // Quick Actions -> Advanced Analyzer (prompt + run quick)
    async function quickAnalysis(type) {
      const prompts = {
        summary: 'Summarize the most important points from recent conversations.',
        personality: 'Analyze the personality traits shown in recent discussions.',
        patterns: 'What communication patterns have emerged lately?',
      };
      try {
        if (typeof toggleAdvancedAnalysis === 'function') {
          const content = document.getElementById('advanced-analysis-content');
          if (content && content.style.display === 'none') {
            toggleAdvancedAnalysis();
          }
        }
        const mount = document.querySelector('#gemma-advanced-analyzer');
        if (!mount) return;
        const promptEl = mount.querySelector('textarea[data-role="prompt"]');
        const runQuickBtn = mount.querySelector('button[data-role="run-quick"]');
        if (promptEl) promptEl.value = prompts[type] || prompts.summary;
        if (runQuickBtn) runQuickBtn.click();
      } catch (e) {
        console.warn('Quick action failed', e);
      }
    }
    window.quickAnalysis = quickAnalysis;
    async function loadGPUStats() {
      try {
        const stats = await api.getGemmaStats();
        console.debug('[GEMMA] Stats', stats);
        if (!stats) return;

        if (stats.model_on_gpu !== undefined) {
          document.getElementById('inference-speed').textContent = stats.model_on_gpu ? '~30 tok/s' : '~10 tok/s (CPU)';
        }

        if (stats.vram_used_mb !== undefined && stats.vram_total_mb) {
          const used = Math.round(stats.vram_used_mb / 1024 * 10) / 10;
          const total = Math.round(stats.vram_total_mb / 1024 * 10) / 10;
          document.getElementById('gpu-memory').textContent = `${used} / ${total} GB`;
        }
      } catch (error) {
        console.error('Failed to load GPU stats:', error);
      }
    }

    // Initialize page with authentication
    async function initPage() {
      // Enforce authentication
      const authenticated = await Auth.init({ requireAuth: true });
      if (!authenticated) return;

      // Load GPU stats
      await loadGPUStats();

      await initGemmaControls();

      // Make sure the analyzer is ready without extra clicks
      ensureAdvancedAnalysisReady();
    }
    // ========================================================================
    // ADVANCED ANALYSIS
    // ========================================================================

    let advancedAnalyzerInstance = null;

    function ensureAdvancedAnalysisReady() {
      const content = document.getElementById('advanced-analysis-content');
      const icon = document.getElementById('analysis-toggle-icon');
      if (content) {
        content.style.display = 'block';
      }
      if (icon) {
        icon.style.transform = 'rotate(180deg)';
      }
      if (typeof initGemmaAnalyzer === 'function') {
        if (!advancedAnalyzerInstance) {
          advancedAnalyzerInstance = initGemmaAnalyzer({ mount: '#gemma-advanced-analyzer' });
        } else if (advancedAnalyzerInstance.refreshCount) {
          advancedAnalyzerInstance.refreshCount();
        }
      }
      syncAnalyzerConfidence(gemmaConfidencePercent);
      syncAnalyzerEmotionsFromState();
    }

    function toggleAdvancedAnalysis() {
      const content = document.getElementById('advanced-analysis-content');
      const icon = document.getElementById('analysis-toggle-icon');
      const isHidden = content.style.display === 'none';

      content.style.display = isHidden ? 'block' : 'none';
      icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';

      if (isHidden) {
        ensureAdvancedAnalysisReady();
      }

      if (window.lucide && window.lucide.createIcons) {
        window.lucide.createIcons();
      }
    }

    window.toggleAdvancedAnalysis = toggleAdvancedAnalysis;

    // ================================================
    // Tab Switching
    // ================================================
    function initTabs() {
      const tabs = document.querySelectorAll('.gemma-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          switchTab(tabName);
        });
      });
    }

    function switchTab(tabName) {
      // Update tab buttons
      const tabs = document.querySelectorAll('.gemma-tab');
      tabs.forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // Update tab content
      const contents = document.querySelectorAll('.gemma-tab-content');
      contents.forEach(content => {
        const shouldBeActive = content.id === `tab-${tabName}`;
        content.classList.toggle('active', shouldBeActive);
        content.style.display = shouldBeActive ? 'block' : 'none';
      });

      // Load data for specific tabs on first view
      if (tabName === 'transcripts' && !transcriptsLoaded) {
        loadTranscriptList();
      }
      if (tabName === 'emotions' && !emotionsLoaded) {
        loadEmotionsDashboard();
      }

      // Re-render icons for the new tab
      if (window.lucide && window.lucide.createIcons) {
        setTimeout(() => window.lucide.createIcons(), 50);
      }
    }

    // ================================================
    // Transcriptions Tab
    // ================================================
    let transcriptsLoaded = false;
    let allTranscripts = [];
    let currentTranscriptIndex = -1;

    // Excel view state
    let currentViewMode = localStorage.getItem('transcriptViewMode') || 'standard';
    let excelSortColumn = 'created_at';
    let excelSortDirection = 'desc';
    let excelFilteredTranscripts = [];
    let selectedExcelRow = -1;

    // Initialize view mode on load
    function initTranscriptViewMode() {
      const mode = localStorage.getItem('transcriptViewMode') || 'standard';
      toggleTranscriptViewMode(mode, false);
    }

    // Toggle between standard (cards) and excel (grid) view
    function toggleTranscriptViewMode(mode, shouldRerender = true) {
      currentViewMode = mode;
      localStorage.setItem('transcriptViewMode', mode);

      const listEl = document.getElementById('transcript-list');
      const excelEl = document.getElementById('excel-transcript-grid');
      const viewBtns = document.querySelectorAll('.view-mode-btn');

      viewBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });

      if (mode === 'excel') {
        if (listEl) listEl.style.display = 'none';
        if (excelEl) excelEl.style.display = 'block';
        if (shouldRerender && transcriptsLoaded) renderExcelGrid(allTranscripts);
      } else {
        if (listEl) listEl.style.display = 'flex';
        if (excelEl) excelEl.style.display = 'none';
      }

      lucide.createIcons();
    }

    // Render Excel grid with transcripts
    function renderExcelGrid(transcripts) {
      const tbody = document.getElementById('excel-transcript-body');
      const countEl = document.getElementById('excel-row-count');
      if (!tbody) return;

      excelFilteredTranscripts = [...transcripts];

      // Sort transcripts
      excelFilteredTranscripts.sort((a, b) => {
        let aVal, bVal;
        switch (excelSortColumn) {
          case 'created_at':
            aVal = new Date(a.created_at || a.timestamp || 0).getTime();
            bVal = new Date(b.created_at || b.timestamp || 0).getTime();
            break;
          case 'speaker':
            aVal = (a.speakers?.[0] || a.speaker || '').toLowerCase();
            bVal = (b.speakers?.[0] || b.speaker || '').toLowerCase();
            break;
          case 'duration':
            aVal = a.audio_duration || a.duration || 0;
            bVal = b.audio_duration || b.duration || 0;
            break;
          case 'emotion':
            aVal = (a.dominant_emotion || '').toLowerCase();
            bVal = (b.dominant_emotion || '').toLowerCase();
            break;
          default:
            aVal = a[excelSortColumn] || '';
            bVal = b[excelSortColumn] || '';
        }
        const cmp = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        return excelSortDirection === 'asc' ? cmp : -cmp;
      });

      // Update count
      if (countEl) countEl.textContent = `${excelFilteredTranscripts.length} transcripts`;

      // Render rows
      if (excelFilteredTranscripts.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="6" class="excel-empty-state">
            <i data-lucide="inbox" style="width: 48px; height: 48px;"></i>
            No transcripts found
          </td></tr>
        `;
        lucide.createIcons();
        return;
      }

      tbody.innerHTML = excelFilteredTranscripts.map((t, idx) => {
        const date = new Date(t.created_at || t.timestamp || Date.now());
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const speaker = t.speakers?.[0] || t.speaker || 'Unknown';
        const duration = formatDuration(t.audio_duration || t.duration || 0);
        const emotion = t.dominant_emotion || 'neutral';
        const preview = (t.full_text || t.text || '').substring(0, 80) + ((t.full_text || t.text || '').length > 80 ? '...' : '');

        return `
          <tr class="excel-tr" tabindex="0" data-idx="${idx}" onclick="viewTranscriptFromExcel(${idx})" onkeydown="handleExcelKeydown(event, ${idx})">
            <td class="excel-td"><span class="cell-date">${escapeHtml(dateStr)}</span></td>
            <td class="excel-td"><span class="cell-speaker">${escapeHtml(speaker)}</span></td>
            <td class="excel-td"><span class="cell-duration">${escapeHtml(duration)}</span></td>
            <td class="excel-td"><span class="excel-emotion-badge ${emotion.toLowerCase()}">${escapeHtml(emotion)}</span></td>
            <td class="excel-td"><span class="cell-preview">${escapeHtml(preview)}</span></td>
            <td class="excel-td">
              <button class="excel-action-btn" onclick="event.stopPropagation(); viewTranscriptFromExcel(${idx})">View</button>
            </td>
          </tr>
        `;
      }).join('');

      // Update sort indicators
      document.querySelectorAll('.excel-th.sortable').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === excelSortColumn) {
          th.classList.add(excelSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
      });

      lucide.createIcons();
    }

    // Sort column
    function sortExcelColumn(column) {
      if (excelSortColumn === column) {
        excelSortDirection = excelSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        excelSortColumn = column;
        excelSortDirection = 'desc';
      }
      renderExcelGrid(allTranscripts);
    }

    // Quick filter across all columns
    function filterExcelGrid(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        renderExcelGrid(allTranscripts);
        return;
      }

      const filtered = allTranscripts.filter(t => {
        const text = (t.full_text || t.text || '').toLowerCase();
        const speaker = (t.speakers?.[0] || t.speaker || '').toLowerCase();
        const emotion = (t.dominant_emotion || '').toLowerCase();
        const jobId = (t.job_id || '').toLowerCase();
        return text.includes(q) || speaker.includes(q) || emotion.includes(q) || jobId.includes(q);
      });

      renderExcelGrid(filtered);
    }

    // Keyboard navigation in Excel grid
    function handleExcelKeydown(event, idx) {
      const rows = document.querySelectorAll('#excel-transcript-body .excel-tr');

      if (event.key === 'ArrowDown' && idx < rows.length - 1) {
        event.preventDefault();
        rows[idx + 1].focus();
      } else if (event.key === 'ArrowUp' && idx > 0) {
        event.preventDefault();
        rows[idx - 1].focus();
      } else if (event.key === 'Enter') {
        event.preventDefault();
        viewTranscriptFromExcel(idx);
      }
    }

    // View transcript from Excel grid
    function viewTranscriptFromExcel(idx) {
      const transcript = excelFilteredTranscripts[idx];
      if (!transcript) return;

      // Find the original index in allTranscripts
      const originalIdx = allTranscripts.findIndex(t => t.job_id === transcript.job_id);

      // Hide both views
      document.getElementById('transcript-list').style.display = 'none';
      document.getElementById('excel-transcript-grid').style.display = 'none';

      // Show detail view
      document.getElementById('transcript-viewer').style.display = 'block';
      document.getElementById('transcript-nav').style.display = 'flex';

      currentTranscriptIndex = originalIdx >= 0 ? originalIdx : idx;
      updateTranscriptNav();
      loadTranscriptDetail(transcript.job_id || transcript.id);
    }

    // Export transcripts to CSV
    function exportTranscriptsCSV() {
      const csvRows = [];
      const headers = ['Date', 'Speaker', 'Duration', 'Emotion', 'Text', 'Job ID'];
      csvRows.push(headers.join(','));

      const data = excelFilteredTranscripts.length > 0 ? excelFilteredTranscripts : allTranscripts;

      data.forEach(t => {
        const date = new Date(t.created_at || t.timestamp || Date.now()).toISOString();
        const speaker = t.speakers?.[0] || t.speaker || 'Unknown';
        const duration = t.audio_duration || t.duration || 0;
        const emotion = t.dominant_emotion || 'neutral';
        const text = (t.full_text || t.text || '').replace(/"/g, '""').replace(/\n/g, ' ');
        const jobId = t.job_id || '';

        csvRows.push([
          `"${date}"`,
          `"${speaker}"`,
          duration.toFixed(2),
          `"${emotion}"`,
          `"${text}"`,
          `"${jobId}"`
        ].join(','));
      });

      const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `transcripts_export_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function loadTranscriptList() {
      const listEl = document.getElementById('transcript-list');
      if (!listEl) return;

      // DEMO MODE: Use mock data instead of API
      const mockTranscripts = [
        {
          job_id: 'demo_001',
          filename: 'Q4 Strategy Call',
          created_at: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
          audio_duration: 1834,
          duration: 1834,
          speaker_count: 3,
          speakers: ['Sarah Chen', 'Michael Ross', 'Jennifer Taylor'],
          dominant_emotion: 'joy',
          full_text: 'This has been an excellent quarter. Our customer satisfaction scores are up 15% and retention is at an all-time high.'
        },
        {
          job_id: 'demo_002',
          filename: 'Customer Support Review',
          created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
          audio_duration: 2456,
          duration: 2456,
          speaker_count: 2,
          speakers: ['Customer', 'Support Agent'],
          dominant_emotion: 'neutral',
          full_text: 'I had some issues with my account but the support team resolved them quickly. Thank you for your help.'
        },
        {
          job_id: 'demo_003',
          filename: 'Product Demo - Enterprise Client',
          created_at: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
          audio_duration: 3621,
          duration: 3621,
          speaker_count: 4,
          speakers: ['Sales Rep', 'CTO', 'CFO', 'CEO'],
          dominant_emotion: 'surprise',
          full_text: 'The AI capabilities you demonstrated are impressive. We did not expect this level of accuracy from transcription.'
        },
        {
          job_id: 'demo_004',
          filename: 'Team Standup - Engineering',
          created_at: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(),
          audio_duration: 892,
          duration: 892,
          speaker_count: 5,
          speakers: ['Tech Lead', 'Dev 1', 'Dev 2', 'Dev 3', 'PM'],
          dominant_emotion: 'neutral',
          full_text: 'Sprint progress is on track. We completed the authentication module and are moving to the dashboard next.'
        },
        {
          job_id: 'demo_005',
          filename: 'Investor Update Call',
          created_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
          audio_duration: 2987,
          duration: 2987,
          speaker_count: 2,
          speakers: ['CEO', 'Investor'],
          dominant_emotion: 'joy',
          full_text: 'Revenue is up 40% year over year. We are excited about the growth trajectory and the new market opportunities.'
        }
      ];

      allTranscripts = mockTranscripts;
      transcriptsLoaded = true;

      if (allTranscripts.length === 0) {
        listEl.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <p class="text-muted">No transcripts available yet.</p>
            </div>
          `;
        return;
      }

      // Render standard card view
      listEl.innerHTML = allTranscripts.map((t, idx) => `
          <div class="transcript-item" onclick="viewTranscript(${idx})">
            <div class="transcript-info">
              <span class="transcript-title">${escapeHtml(t.filename || t.job_id || 'Transcript ' + (idx + 1))}</span>
              <span class="transcript-meta">
                ${new Date(t.created_at || t.timestamp || Date.now()).toLocaleDateString()} |
                ${t.duration ? formatDuration(t.duration) : ''} |
                ${t.speaker_count ? t.speaker_count + ' speakers' : ''}
              </span>
            </div>
            <i data-lucide="chevron-right" style="width: 20px; height: 20px; color: var(--text-secondary);"></i>
          </div>
        `).join('');

      // Also render Excel grid
      renderExcelGrid(allTranscripts);

      // Initialize correct view mode
      initTranscriptViewMode();

      lucide.createIcons();
    }

    function viewTranscript(index) {
      currentTranscriptIndex = index;
      const transcript = allTranscripts[index];
      if (!transcript) return;

      document.getElementById('transcript-list').style.display = 'none';
      document.getElementById('transcript-viewer').style.display = 'block';
      document.getElementById('transcript-nav').style.display = 'flex';

      updateTranscriptNav();
      loadTranscriptDetail(transcript.job_id || transcript.id);
    }

    // Emotion colors for badges
    const EMOTION_COLORS = {
      joy: '#10b981',
      anger: '#ef4444',
      sadness: '#3b82f6',
      fear: '#8b5cf6',
      surprise: '#f59e0b',
      disgust: '#84cc16',
      neutral: '#6b7280'
    };

    let currentTranscriptSegments = [];
    let activeEmotionFilter = 'all';
    let currentTranscriptJobId = null;

    async function loadTranscriptDetail(jobId) {
      const viewer = document.getElementById('transcript-viewer');
      viewer.innerHTML = '<div class="skeleton" style="height: 200px;"></div>';
      currentTranscriptJobId = jobId;

      // Show insights panel
      const insightsPanel = document.getElementById('transcript-insights-panel');
      if (insightsPanel) insightsPanel.style.display = 'block';

      // DEMO MODE: Use mock segments based on jobId
      const mockSegmentsMap = {
        'demo_001': [
          { speaker: 'Sarah Chen', text: 'Good morning everyone. Let us review our Q4 performance.', emotion: 'neutral', start: 0, end: 5 },
          { speaker: 'Michael Ross', text: 'The numbers are looking great. We exceeded our targets by 15%.', emotion: 'joy', start: 5, end: 12 },
          { speaker: 'Jennifer Taylor', text: 'Customer retention hit 94% this quarter.', emotion: 'joy', start: 12, end: 18 },
          { speaker: 'Sarah Chen', text: 'That is excellent news. What drove this improvement?', emotion: 'surprise', start: 18, end: 23 },
          { speaker: 'Michael Ross', text: 'The new onboarding flow reduced churn significantly.', emotion: 'neutral', start: 23, end: 30 }
        ],
        'demo_002': [
          { speaker: 'Customer', text: 'I am really frustrated with the downtime yesterday. It cost us business.', emotion: 'anger', start: 0, end: 6 },
          { speaker: 'Support Agent', text: 'I completely understand your frustration. Let me look into this right away.', emotion: 'neutral', start: 6, end: 12 },
          { speaker: 'Customer', text: 'I hope this does not happen again.', emotion: 'sadness', start: 12, end: 16 },
          { speaker: 'Support Agent', text: 'I have identified the issue. We have pushed a fix and added monitoring.', emotion: 'neutral', start: 16, end: 24 },
          { speaker: 'Customer', text: 'Okay, that is good to hear. Thank you for the quick response.', emotion: 'joy', start: 24, end: 30 }
        ],
        'demo_003': [
          { speaker: 'Sales Rep', text: 'Thank you all for joining. Let me show you our AI capabilities.', emotion: 'neutral', start: 0, end: 6 },
          { speaker: 'CTO', text: 'We are particularly interested in the transcription accuracy.', emotion: 'neutral', start: 6, end: 12 },
          { speaker: 'Sales Rep', text: 'Our accuracy rate is 99.8%. Here is a live demo.', emotion: 'joy', start: 12, end: 18 },
          { speaker: 'CFO', text: 'What about the pricing model?', emotion: 'neutral', start: 18, end: 22 },
          { speaker: 'CEO', text: 'This is impressive. We did not expect this level of quality.', emotion: 'surprise', start: 22, end: 30 }
        ],
        'demo_004': [
          { speaker: 'Tech Lead', text: 'Good morning team. Let us go around for updates.', emotion: 'neutral', start: 0, end: 4 },
          { speaker: 'Dev 1', text: 'I completed the authentication module yesterday.', emotion: 'neutral', start: 4, end: 8 },
          { speaker: 'Dev 2', text: 'I am working on the dashboard components.', emotion: 'neutral', start: 8, end: 12 },
          { speaker: 'PM', text: 'Any blockers we should discuss?', emotion: 'neutral', start: 12, end: 15 },
          { speaker: 'Dev 3', text: 'All good on my end. Sprint is on track.', emotion: 'joy', start: 15, end: 18 }
        ],
        'demo_005': [
          { speaker: 'CEO', text: 'Thank you for joining this update call.', emotion: 'neutral', start: 0, end: 4 },
          { speaker: 'Investor', text: 'We are excited to hear about the progress.', emotion: 'joy', start: 4, end: 8 },
          { speaker: 'CEO', text: 'Revenue is up 40% year over year.', emotion: 'joy', start: 8, end: 14 },
          { speaker: 'Investor', text: 'That is remarkable growth. What is driving this?', emotion: 'surprise', start: 14, end: 20 },
          { speaker: 'CEO', text: 'Enterprise adoption has accelerated significantly.', emotion: 'joy', start: 20, end: 26 }
        ]
      };

      // Simulate brief loading delay
      await new Promise(resolve => setTimeout(resolve, 300));

      currentTranscriptSegments = mockSegmentsMap[jobId] || mockSegmentsMap['demo_001'];

      // Update metrics
      const speakers = new Set(currentTranscriptSegments.map(s => s.speaker).filter(Boolean));
      const duration = currentTranscriptSegments.length > 0
        ? currentTranscriptSegments[currentTranscriptSegments.length - 1].end || currentTranscriptSegments[currentTranscriptSegments.length - 1].start || 0
        : 0;
      const emotionCounts = {};
      currentTranscriptSegments.forEach(s => {
        const e = s.emotion || 'neutral';
        emotionCounts[e] = (emotionCounts[e] || 0) + 1;
      });
      const dominantEmotion = Object.entries(emotionCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || '-';

      document.getElementById('metric-segments').textContent = currentTranscriptSegments.length;
      document.getElementById('metric-speakers').textContent = speakers.size || '-';
      document.getElementById('metric-duration').textContent = formatDuration(duration);
      document.getElementById('metric-emotion').textContent = dominantEmotion.charAt(0).toUpperCase() + dominantEmotion.slice(1);

      // Load saved notes
      loadTranscriptNotes(jobId);

      // Render segments with emotion badges
      renderTranscriptSegments();
    }

    function renderTranscriptSegments() {
      const viewer = document.getElementById('transcript-viewer');
      const filtered = activeEmotionFilter === 'all'
        ? currentTranscriptSegments
        : currentTranscriptSegments.filter(s => (s.emotion || 'neutral') === activeEmotionFilter);

      if (filtered.length === 0) {
        viewer.innerHTML = '<p class="text-muted" style="text-align:center;padding:2rem;">No segments match the selected emotion filter.</p>';
        return;
      }

      viewer.innerHTML = filtered.map(seg => {
        const emotion = seg.emotion || 'neutral';
        const color = EMOTION_COLORS[emotion] || '#6b7280';
        return `
          <div class="transcript-segment" data-time="${seg.start || 0}" data-emotion="${emotion}" style="border-left: 3px solid ${color};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem;">
              <span style="font-weight: 500; color: var(--primary);">${escapeHtml(seg.speaker || 'Speaker')}</span>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="emotion-badge" style="background: ${color}20; color: ${color}; padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.75rem; font-weight: 500;">
                  ${emotion.charAt(0).toUpperCase() + emotion.slice(1)}
                </span>
                <span style="font-size: 0.8rem; color: var(--text-secondary);">${formatTime(seg.start || 0)}</span>
              </div>
            </div>
            <p style="margin: 0; line-height: 1.5;">${escapeHtml(seg.text || seg.content || '')}</p>
          </div>
        `;
      }).join('');
    }

    function filterTranscriptsByEmotion(emotion) {
      activeEmotionFilter = emotion;

      // Update chip states
      document.querySelectorAll('#transcript-emotion-filters .chip-toggle').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.emotion === emotion);
      });

      // Re-render segments
      if (currentTranscriptSegments.length > 0) {
        renderTranscriptSegments();
      }
    }

    // Notes management
    function loadTranscriptNotes(jobId) {
      const notesEl = document.getElementById('transcript-notes');
      if (!notesEl) return;
      const saved = localStorage.getItem(`transcript_notes_${jobId}`) || '';
      notesEl.value = saved;
    }

    function saveTranscriptNotes() {
      if (!currentTranscriptJobId) return;
      const notes = document.getElementById('transcript-notes').value;
      localStorage.setItem(`transcript_notes_${currentTranscriptJobId}`, notes);

      // Visual feedback
      const btn = document.getElementById('save-notes-btn');
      const original = btn.innerHTML;
      btn.innerHTML = '<i data-lucide="check" style="width: 14px; height: 14px;"></i> Saved!';
      btn.disabled = true;
      setTimeout(() => {
        btn.innerHTML = original;
        btn.disabled = false;
        if (window.lucide) lucide.createIcons();
      }, 1500);
    }

    // AI Summary generation
    async function generateTranscriptSummary() {
      if (!currentTranscriptJobId || currentTranscriptSegments.length === 0) return;

      const btn = document.getElementById('generate-summary-btn');
      const insightsEl = document.getElementById('ai-insights');
      const contentEl = document.getElementById('ai-insights-content');

      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader" style="width: 14px; height: 14px;" class="animate-spin"></i> Generating...';
      insightsEl.style.display = 'block';
      contentEl.innerHTML = '<div class="skeleton" style="height: 60px;"></div>';

      try {
        // Build transcript text for summarization
        const transcriptText = currentTranscriptSegments
          .map(s => `${s.speaker || 'Speaker'}: ${s.text || s.content || ''}`)
          .join('\n');

        const prompt = `Analyze this conversation transcript and provide:
1. A brief summary (2-3 sentences)
2. Key themes or topics discussed
3. Notable emotional moments
4. Action items if any

Transcript:
${transcriptText.slice(0, 4000)}`;

        // Get CSRF token for POST request
        const summaryCSRF = document.cookie.split('; ').find(row => row.startsWith('ws_csrf='))?.split('=')[1] || '';

        const response = await fetch('/api/gemma/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': summaryCSRF
          },
          credentials: 'include',
          body: JSON.stringify({
            message: prompt,
            context: 'transcript_analysis'
          })
        });

        if (!response.ok) throw new Error('Failed to generate summary');

        const data = await response.json();
        const summary = data.response || data.message || data.text || 'No summary generated.';

        // Format and display
        contentEl.innerHTML = `<div style="white-space: pre-wrap;">${escapeHtml(summary)}</div>`;

      } catch (error) {
        console.error('Summary generation error:', error);
        contentEl.innerHTML = '<p class="text-muted">Failed to generate summary. Please try again.</p>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="wand-2" style="width: 14px; height: 14px;"></i> Generate Summary';
        if (window.lucide) lucide.createIcons();
      }
    }

    // Export new functions globally
    window.filterTranscriptsByEmotion = filterTranscriptsByEmotion;
    window.saveTranscriptNotes = saveTranscriptNotes;
    window.generateTranscriptSummary = generateTranscriptSummary;

    function navigateTranscript(direction) {
      if (direction === 'prev' && currentTranscriptIndex > 0) {
        viewTranscript(currentTranscriptIndex - 1);
      } else if (direction === 'next' && currentTranscriptIndex < allTranscripts.length - 1) {
        viewTranscript(currentTranscriptIndex + 1);
      }
    }

    function updateTranscriptNav() {
      document.getElementById('transcript-position').textContent =
        `${currentTranscriptIndex + 1} of ${allTranscripts.length}`;
      document.getElementById('prev-transcript-btn').disabled = currentTranscriptIndex <= 0;
      document.getElementById('next-transcript-btn').disabled = currentTranscriptIndex >= allTranscripts.length - 1;
    }

    function returnToTranscriptList() {
      // Restore correct view based on current mode
      const listEl = document.getElementById('transcript-list');
      const excelEl = document.getElementById('excel-transcript-grid');

      if (currentViewMode === 'excel') {
        if (listEl) listEl.style.display = 'none';
        if (excelEl) excelEl.style.display = 'block';
      } else {
        if (listEl) listEl.style.display = 'flex';
        if (excelEl) excelEl.style.display = 'none';
      }

      document.getElementById('transcript-viewer').style.display = 'none';
      document.getElementById('transcript-nav').style.display = 'none';
      const insightsPanel = document.getElementById('transcript-insights-panel');
      if (insightsPanel) insightsPanel.style.display = 'none';
      currentTranscriptIndex = -1;
      activeEmotionFilter = 'all';
      // Reset filter chips
      document.querySelectorAll('#transcript-emotion-filters .chip-toggle').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.emotion === 'all');
      });
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function formatDuration(seconds) {
      const m = Math.floor(seconds / 60);
      return `${m} min`;
    }

    // ================================================
    // Emotions Tab (Modular Integration)
    // ================================================

    // Utility for HTML escaping
    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    let emotionsLoaded = false;
    let emotionsModule = null;
    let emotionsPieChart = null;
    let emotionsTrendChart = null;
    let emotionsRadarChart = null;
    let currentEmotionsPeriod = 'today';

    async function loadEmotionsDashboard(period = 'today') {
      currentEmotionsPeriod = period;

      // DEMO MODE: Use mock emotion analytics data
      const mockAnalytics = {
        summary: {
          joy_count: 127,
          joy: 127,
          anger: 23,
          sadness: 18,
          fear: 8,
          surprise: 45,
          neutral: 189,
          total_analyzed: 410,
          total: 410,
          avg_pace_wpm: 142,
          avg_pitch_mean: 215,
          emotion_totals: {
            joy: 127,
            neutral: 189,
            surprise: 45,
            anger: 23,
            sadness: 18,
            fear: 8
          }
        },
        timeline: {
          labels: ['9AM', '10AM', '11AM', '12PM', '1PM', '2PM', '3PM', '4PM', '5PM'],
          emotions: {
            joy: [12, 18, 22, 15, 10, 14, 16, 12, 8],
            neutral: [25, 30, 28, 22, 18, 24, 20, 14, 8],
            anger: [2, 4, 3, 5, 2, 3, 2, 1, 1],
            sadness: [1, 2, 3, 2, 4, 3, 2, 1, 0]
          }
        },
        speakers: [
          { speaker: 'Sarah Chen', segments: 85, dominant_emotion: 'joy', speech_metrics: { pace_wpm: 148, pitch_mean: 220, energy_mean: 0.72 } },
          { speaker: 'Michael Ross', segments: 72, dominant_emotion: 'neutral', speech_metrics: { pace_wpm: 135, pitch_mean: 180, energy_mean: 0.58 } },
          { speaker: 'Jennifer Taylor', segments: 64, dominant_emotion: 'surprise', speech_metrics: { pace_wpm: 155, pitch_mean: 235, energy_mean: 0.81 } },
          { speaker: 'David Kim', segments: 58, dominant_emotion: 'neutral', speech_metrics: { pace_wpm: 128, pitch_mean: 165, energy_mean: 0.45 } }
        ]
      };

      emotionsLoaded = true;

      // Update stat cards
      const summary = mockAnalytics.summary;
      document.getElementById('stat-joy').textContent = summary.joy_count || summary.joy || 0;
      document.getElementById('stat-negative').textContent =
        (summary.anger || 0) + (summary.sadness || 0) + (summary.fear || 0);
      document.getElementById('stat-total').textContent = summary.total_analyzed || summary.total || 0;
      document.getElementById('stat-pace').textContent = summary.avg_pace_wpm ? Math.round(summary.avg_pace_wpm) : '-';
      document.getElementById('stat-pitch').textContent = summary.avg_pitch_mean ? Math.round(summary.avg_pitch_mean) : '-';

      // Render charts
      const totals = summary.emotion_totals || summary.emotions || {};
      renderEmotionsDistributionChart(totals);
      renderEmotionsTrendChart(mockAnalytics.timeline || {});
      renderSpeechRadarChart(mockAnalytics.speakers || []);

      // Render speaker table
      renderSpeakerTable(mockAnalytics.speakers || []);

      // Load moments
      loadEmotionMoments();
    }

    function renderEmotionsDistributionChart(totals) {
      const ctx = document.getElementById('emotion-distribution-chart');
      if (!ctx) return;

      const labels = Object.keys(totals);
      const data = Object.values(totals);
      const colors = labels.map(e => EMOTION_COLORS[e] || '#6b7280');

      if (emotionsPieChart) emotionsPieChart.destroy();

      emotionsPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels.map(k => k.charAt(0).toUpperCase() + k.slice(1)),
          datasets: [{ data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '55%',
          plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } },
          onClick: (evt, active) => {
            if (active.length) {
              const index = active[0].index;
              const emotionKey = labels[index];
              loadEmotionMoments(emotionKey);
              // Update chip UI
              document.querySelectorAll('#moment-emotion-filter .chip-toggle').forEach(c => {
                c.classList.toggle('active', c.dataset.emotion === emotionKey);
              });
            }
          },
          onHover: (event, chartElement) => {
            event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
          }
        }
      });
    }

    function renderEmotionsTrendChart(timeline) {
      const ctx = document.getElementById('emotion-trend-chart');
      if (!ctx) return;

      const labels = timeline.labels || [];
      const emotionData = timeline.emotions || {};

      const datasets = Object.entries(emotionData).map(([emotion, values]) => ({
        label: emotion.charAt(0).toUpperCase() + emotion.slice(1),
        data: values,
        borderColor: EMOTION_COLORS[emotion] || '#6b7280',
        backgroundColor: (EMOTION_COLORS[emotion] || '#6b7280') + '20',
        fill: true,
        tension: 0.4
      }));

      if (emotionsTrendChart) emotionsTrendChart.destroy();

      emotionsTrendChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    function renderSpeechRadarChart(speakers) {
      const ctx = document.getElementById('speech-radar-chart');
      if (!ctx) return;

      const metrics = ['pace_wpm', 'pitch_mean', 'energy_mean'];
      const labels = ['Pace', 'Pitch', 'Energy'];
      const maxVals = { pace_wpm: 200, pitch_mean: 300, energy_mean: 1 };

      const datasets = speakers.slice(0, 4).map((s, i) => {
        const color = ['#a78bfa', '#f472b6', '#fb923c', '#4ade80'][i];
        return {
          label: s.speaker || 'Unknown',
          data: metrics.map(m => Math.min(100, ((s.speech_metrics?.[m] || 0) / maxVals[m]) * 100)),
          borderColor: color,
          backgroundColor: color + '33',
          pointBackgroundColor: color
        };
      });

      if (emotionsRadarChart) emotionsRadarChart.destroy();

      emotionsRadarChart = new Chart(ctx, {
        type: 'radar',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { r: { beginAtZero: true, max: 100, ticks: { display: false } } },
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    function renderSpeakerTable(speakers) {
      const tbody = document.getElementById('speaker-table-body');
      if (!tbody) return;

      if (!speakers.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No speaker data.</td></tr>';
        return;
      }

      tbody.innerHTML = speakers.slice(0, 8).map(s => {
        const emotion = s.dominant_emotion || 'neutral';
        const emotionColor = EMOTION_COLORS[emotion] || '#6b7280';
        const speakerName = s.speaker || 'Unknown';
        return `
          <tr style="cursor: pointer; transition: background 0.2s;" onclick="loadEmotionMoments(null, '${escapeHtml(speakerName)}'); this.parentElement.querySelectorAll('tr').forEach(r => r.style.background=''); this.style.background='rgba(0,82,204,0.05)';" title="Click to filter moments by ${escapeHtml(speakerName)}">
            <td style="padding: 0.5rem;">${escapeHtml(speakerName)}</td>
            <td>${s.segments || 0}</td>
            <td><span style="background:${emotionColor}20;color:${emotionColor};padding:0.1rem 0.4rem;border-radius:999px;font-size:0.75rem;">${emotion}</span></td>
            <td>${s.speech_metrics?.pace_wpm ? Math.round(s.speech_metrics.pace_wpm) : '-'}</td>
            <td>${s.speech_metrics?.pitch_mean ? Math.round(s.speech_metrics.pitch_mean) : '-'}</td>
          </tr>
        `;
      }).join('');
    }

    async function loadEmotionMoments(emotion = null, speaker = null) {
      const container = document.getElementById('emotion-moment-feed');
      if (!container) return;

      // DEMO MODE: Use mock emotion moments data
      const mockMoments = [
        { speaker: 'Sarah Chen', emotion: 'joy', text: 'This has been our best quarter yet. The team really came together.' },
        { speaker: 'Michael Ross', emotion: 'surprise', text: 'I did not expect the retention numbers to be this high.' },
        { speaker: 'Customer', emotion: 'anger', text: 'The downtime yesterday was unacceptable. We lost several deals.' },
        { speaker: 'Jennifer Taylor', emotion: 'joy', text: 'Customer satisfaction scores are through the roof.' },
        { speaker: 'Support Agent', emotion: 'neutral', text: 'I understand your concern. Let me escalate this immediately.' },
        { speaker: 'CTO', emotion: 'surprise', text: 'The AI accuracy is remarkable. This exceeds our requirements.' },
        { speaker: 'CEO', emotion: 'joy', text: 'Revenue growth is accelerating. We are ahead of projections.' },
        { speaker: 'Customer', emotion: 'sadness', text: 'We were hoping for a faster resolution to this issue.' },
        { speaker: 'Dev 1', emotion: 'neutral', text: 'The authentication module is complete and tested.' },
        { speaker: 'Investor', emotion: 'joy', text: 'These growth numbers are impressive. We are excited about the trajectory.' },
        { speaker: 'Tech Lead', emotion: 'neutral', text: 'Sprint velocity is stable. We are on track for the release.' },
        { speaker: 'Sales Rep', emotion: 'joy', text: 'We closed three enterprise deals this week.' }
      ];

      // Filter by emotion if specified
      let filteredMoments = mockMoments;
      if (emotion && emotion !== 'all') {
        filteredMoments = mockMoments.filter(m => m.emotion === emotion);
      }
      if (speaker) {
        filteredMoments = filteredMoments.filter(m => m.speaker === speaker);
      }

      if (!filteredMoments.length) {
        container.innerHTML = '<p class="text-muted" style="text-align:center;padding:2rem;">No emotional moments match the filter.</p>';
        return;
      }

      container.innerHTML = filteredMoments.slice(0, 15).map(m => {
        const emotionColor = EMOTION_COLORS[m.emotion] || '#6b7280';
        return `
          <div class="moment-card" style="background:#fff;border:1px solid rgba(0,82,204,0.08);border-radius:0.75rem;padding:1rem;margin-bottom:0.75rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
              <span style="font-weight:500;">${escapeHtml(m.speaker || 'Speaker')}</span>
              <span style="background:${emotionColor}20;color:${emotionColor};padding:0.15rem 0.5rem;border-radius:999px;font-size:0.75rem;">
                ${m.emotion || 'neutral'}
              </span>
            </div>
            <p style="margin:0;color:var(--text-secondary);font-size:0.9rem;line-height:1.5;">${escapeHtml(m.text || '')}</p>
          </div>
        `;
      }).join('');
    }

    function filterEmotionsPeriod(period) {
      document.querySelectorAll('#emotions-period-chips .chip-toggle').forEach(c => {
        c.classList.toggle('active', c.dataset.period === period);
      });
      loadEmotionsDashboard(period);
    }

    function filterMomentEmotion(emotion) {
      document.querySelectorAll('#moment-emotion-filter .chip-toggle').forEach(c => {
        c.classList.toggle('active', c.dataset.emotion === emotion);
      });
      loadEmotionMoments(emotion);
    }

    // Export functions globally
    window.filterEmotionsPeriod = filterEmotionsPeriod;
    window.filterMomentEmotion = filterMomentEmotion;

    // ================================================
    // Search Tab
    // ================================================
    async function performSemanticSearch() {
      const input = document.getElementById('semantic-search-input');
      const resultsEl = document.getElementById('search-results');

      if (!input || !input.value.trim()) return;

      const query = input.value.trim().toLowerCase();
      resultsEl.innerHTML = '<div class="skeleton" style="height: 100px;"></div>';

      // Simulate brief loading delay
      await new Promise(resolve => setTimeout(resolve, 400));

      // DEMO MODE: Use mock search results from transcript data
      const mockSearchData = [
        { job_id: 'demo_001', speaker: 'Sarah Chen', filename: 'Q4 Strategy Call', text: 'Good morning everyone. Let us review our Q4 performance and discuss next steps.', start_time: 0 },
        { job_id: 'demo_001', speaker: 'Michael Ross', filename: 'Q4 Strategy Call', text: 'The numbers are looking great. We exceeded our targets by 15% this quarter.', start_time: 5 },
        { job_id: 'demo_001', speaker: 'Jennifer Taylor', filename: 'Q4 Strategy Call', text: 'Customer retention hit 94% this quarter, our best performance yet.', start_time: 12 },
        { job_id: 'demo_002', speaker: 'Customer', filename: 'Customer Support Review', text: 'I am really frustrated with the downtime yesterday. It cost us business.', start_time: 0 },
        { job_id: 'demo_002', speaker: 'Support Agent', filename: 'Customer Support Review', text: 'I completely understand your frustration. Let me look into this right away.', start_time: 6 },
        { job_id: 'demo_003', speaker: 'CTO', filename: 'Product Demo', text: 'We are particularly interested in the transcription accuracy and AI capabilities.', start_time: 6 },
        { job_id: 'demo_003', speaker: 'CEO', filename: 'Product Demo', text: 'This is impressive. We did not expect this level of quality from the AI.', start_time: 22 },
        { job_id: 'demo_005', speaker: 'CEO', filename: 'Investor Update', text: 'Revenue is up 40% year over year thanks to enterprise adoption.', start_time: 8 },
        { job_id: 'demo_005', speaker: 'Investor', filename: 'Investor Update', text: 'That is remarkable growth. What is driving the enterprise success?', start_time: 14 },
        { job_id: 'demo_004', speaker: 'Dev 1', filename: 'Team Standup', text: 'I completed the authentication module yesterday, all tests passing.', start_time: 4 }
      ];

      // Filter results based on query
      const results = mockSearchData.filter(r =>
        r.text.toLowerCase().includes(query) ||
        r.speaker.toLowerCase().includes(query) ||
        r.filename.toLowerCase().includes(query)
      );

      if (results.length === 0) {
        resultsEl.innerHTML = '<p class="text-muted" style="text-align:center;padding:2rem;">No results found for "' + escapeHtml(query) + '"</p>';
        return;
      }

      resultsEl.innerHTML = results.map(r => `
        <div class="search-result-item" onclick="jumpToSearchResult('${r.job_id || ''}', ${r.start_time || 0})">
          <div class="result-title">${escapeHtml(r.speaker || 'Speaker')} - ${r.filename || 'Transcript'}</div>
          <div class="result-snippet">${highlightQuery(r.text || r.content || '', input.value.trim())}</div>
        </div>
      `).join('');
    }

    function highlightQuery(text, query) {
      const escaped = escapeHtml(text);
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return escaped.replace(regex, '<mark>$1</mark>');
    }

    function jumpToSearchResult(jobId, startTime) {
      if (jobId) {
        window.location.href = `transcripts.html?job=${jobId}&t=${startTime}`;
      }
    }

    // Export functions globally
    window.viewTranscript = viewTranscript;
    window.navigateTranscript = navigateTranscript;
    window.returnToTranscriptList = returnToTranscriptList;
    window.performSemanticSearch = performSemanticSearch;
    window.jumpToSearchResult = jumpToSearchResult;

    // ================================================
    // Chat Functionality
    // ================================================

    // Conversation history for context (limited to avoid token overflow)
    const chatHistory = [];
    const MAX_HISTORY = 6; // Keep last 6 messages (3 exchanges) to stay under 8k context

    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      addChatMessage(message, 'user');

      // Add to history for general chat mode
      chatHistory.push({ role: 'user', content: message });

      // Trim history if too long to prevent OOM
      while (chatHistory.length > MAX_HISTORY) {
        chatHistory.shift();
      }

      // Show thinking indicator
      const thinkingId = addThinkingIndicator();

      try {
        let response, aiResponse;

        if (activeDatabase && activeDatabase.isReady) {
          // ========================================
          // RAG MODE: Query the active database
          // ========================================
          // Get CSRF token from cookie
          const csrfToken = document.cookie.split('; ').find(row => row.startsWith('ws_csrf='))?.split('=')[1] || '';

          // Use 60s timeout since Gemma can take up to 30s
          const askController = new AbortController();
          const askTimeout = setTimeout(() => askController.abort(), 60000);

          try {
            response = await fetch('/ask', {
              method: 'POST',
              credentials: 'include',
              signal: askController.signal,
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
              },
              body: JSON.stringify({
                filename: activeDatabase.filename,
                question: message
              })
            });
            clearTimeout(askTimeout);
          } catch (fetchError) {
            clearTimeout(askTimeout);
            if (fetchError.name === 'AbortError') {
              throw new Error('Request timed out. Please try a simpler question.');
            }
            throw fetchError;
          }

          if (response.ok) {
            const data = await response.json();
            aiResponse = data.answer || 'I couldn\'t find relevant information in the database.';

            // Add source context if available
            if (data.context && data.context.length > 0) {
              aiResponse += `\n\nüìã *Based on: ${activeDatabase.displayName}*`;
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            aiResponse = `Sorry, I couldn't query the database: ${errorData.detail || 'Unknown error'}`;
          }
        } else {
          // ========================================
          // GENERAL CHAT MODE: No database context
          // ========================================
          response = await fetch('/api/public/chat', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: chatHistory,
              max_tokens: 500,
              temperature: 0.7,
              top_p: 0.9
            })
          });

          if (response.ok) {
            const data = await response.json();
            aiResponse = data.message || data.text || 'I received your message but had trouble generating a response.';

            // Add AI response to history
            chatHistory.push({ role: 'assistant', content: aiResponse });

            // Trim again after adding response
            while (chatHistory.length > MAX_HISTORY) {
              chatHistory.shift();
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            const errorMsg = errorData.detail || errorData.message || `Error ${response.status}`;
            aiResponse = `Sorry, I encountered an error: ${errorMsg}`;
          }
        }

        removeThinkingIndicator(thinkingId);
        addChatMessage(aiResponse, 'ai');

      } catch (error) {
        console.error('Chat error:', error);
        removeThinkingIndicator(thinkingId);
        addChatMessage('Connection error. Please check your connection and try again.', 'ai');
      }
    }

    function addThinkingIndicator() {
      const container = document.getElementById('chat-messages');
      const id = 'thinking-' + Date.now();
      const html = `
        <div id="${id}" class="chat-message-row">
          <div class="chat-avatar-icon ai-avatar">
            <i data-lucide="bot" style="width: 18px; height: 18px; color: white;"></i>
          </div>
          <div class="chat-bubble-content ai-bubble">
            <div class="thinking-dots">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
      container.scrollTop = container.scrollHeight;
      lucide.createIcons();
      return id;
    }

    function removeThinkingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function addChatMessage(text, sender) {
      const container = document.getElementById('chat-messages');
      const isUser = sender === 'user';

      // Simple markdown renderer for AI messages
      let formattedText = text;
      if (!isUser) {
        formattedText = renderMarkdown(text);
      }

      const messageHtml = `
        <div class="chat-message-row ${isUser ? 'user' : ''}">
          ${!isUser ? `
            <div class="chat-avatar-icon ai-avatar">
              <i data-lucide="bot" style="width: 18px; height: 18px; color: white;"></i>
            </div>
          ` : ''}
          <div class="chat-bubble-content ${isUser ? 'user-bubble' : 'ai-bubble'}">
            ${formattedText}
          </div>
          ${isUser ? `
            <div class="chat-avatar-icon user-avatar">
              <i data-lucide="user" style="width: 18px; height: 18px; color: white;"></i>
            </div>
          ` : ''}
        </div>
      `;

      container.insertAdjacentHTML('beforeend', messageHtml);
      container.scrollTop = container.scrollHeight;

      if (window.lucide && window.lucide.createIcons) {
        window.lucide.createIcons();
      }
    }

    function renderMarkdown(text) {
      // Escape HTML first
      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // Headers (## and ###)
      html = html.replace(/^### (.+)$/gm, '<h4 style="margin: 0.8em 0 0.4em; color: #a78bfa; font-size: 0.95em;">$1</h4>');
      html = html.replace(/^## (.+)$/gm, '<h3 style="margin: 1em 0 0.5em; color: #c4b5fd; font-size: 1.05em;">$1</h3>');

      // Bold (**text** or __text__)
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong style="color: #e0d4ff;">$1</strong>');
      html = html.replace(/__([^_]+)__/g, '<strong style="color: #e0d4ff;">$1</strong>');

      // Italic (*text* or _text_)
      html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      html = html.replace(/_([^_]+)_/g, '<em>$1</em>');

      // Bullet points (* or -)
      html = html.replace(/^\s*[\*\-]\s+(.+)$/gm, '<li style="margin: 0.3em 0; padding-left: 0.5em;">$1</li>');

      // Wrap consecutive <li> in <ul>
      html = html.replace(/(<li[^>]*>.*?<\/li>\s*)+/g, (match) => {
        return `<ul style="margin: 0.5em 0; padding-left: 1.2em; list-style-type: disc;">${match}</ul>`;
      });

      // Numbers (1. 2. etc)
      html = html.replace(/^\s*(\d+)\.\s+(.+)$/gm, '<li style="margin: 0.3em 0;">$2</li>');

      // Code inline (`code`)
      html = html.replace(/`([^`]+)`/g, '<code style="background: rgba(139, 92, 246, 0.2); padding: 0.1em 0.4em; border-radius: 4px; font-size: 0.9em;">$1</code>');

      // Line breaks (double newline = paragraph, single = br)
      html = html.replace(/\n\n+/g, '</p><p style="margin: 0.8em 0;">');
      html = html.replace(/\n/g, '<br>');

      // Wrap in paragraph
      html = `<div style="line-height: 1.6;">${html}</div>`;

      return html;
    }

    function useQuickPrompt(prompt) {
      document.getElementById('chat-input').value = prompt;
      sendChatMessage();
    }

    // Chat input enter key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.activeElement.id === 'chat-input') {
        e.preventDefault();
        sendChatMessage();
      }
    });

    // ================================================
    // Database Upload
    // ================================================
    function initDatabaseUpload() {
      const dropZone = document.getElementById('db-upload-zone');
      if (!dropZone) return;

      // Drag and drop
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.csv'));
        if (files.length > 0) {
          processUploadedFiles(files);
        }
      });
    }

    function handleDatabaseUpload(event) {
      const files = Array.from(event.target.files).filter(f => f.name.endsWith('.csv'));
      if (files.length > 0) {
        processUploadedFiles(files);
      }
    }

    async function processUploadedFiles(files) {
      const listContainer = document.getElementById('db-file-list');

      for (const file of files) {
        // Add file to list with pending status
        const fileId = `file-${Date.now()}`;
        const fileHtml = `
          <div class="db-file-item" id="${fileId}">
            <div class="db-file-info">
              <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
              <div>
                <div style="font-weight: 500;">${file.name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${(file.size / 1024).toFixed(1)} KB</div>
              </div>
            </div>
            <span class="db-file-status pending">Pending</span>
          </div>
        `;
        listContainer.insertAdjacentHTML('beforeend', fileHtml);
        if (window.lucide) window.lucide.createIcons();

        const statusEl = document.querySelector(`#${fileId} .db-file-status`);

        try {
          // Step 1: Upload file with progress tracking
          const formData = new FormData();
          formData.append('file', file);

          // Get CSRF token for all POST requests
          const uploadCsrf = document.cookie.split('; ').find(row => row.startsWith('ws_csrf='))?.split('=')[1] || '';

          // Update UI to show progress bar
          const fileItem = document.getElementById(fileId);
          fileItem.innerHTML = `
            <div class="db-file-info">
              <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
              <div style="flex: 1;">
                <div style="font-weight: 500;">${file.name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">
                  <span id="${fileId}-progress-text">0%</span> - 
                  <span id="${fileId}-progress-mb">0 / ${(file.size / 1024 / 1024).toFixed(1)} MB</span>
                </div>
                <div style="width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; margin-top: 4px;">
                  <div id="${fileId}-progress-bar" style="width: 0%; height: 100%; background: var(--primary-color); border-radius: 3px; transition: width 0.2s;"></div>
                </div>
              </div>
            </div>
            <span class="db-file-status processing">Uploading...</span>
          `;
          if (window.lucide) window.lucide.createIcons();

          // Use XMLHttpRequest for progress tracking
          const uploadData = await new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();

            xhr.upload.onprogress = (e) => {
              if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                const loadedMB = (e.loaded / 1024 / 1024).toFixed(1);
                const totalMB = (e.total / 1024 / 1024).toFixed(1);

                const progressBar = document.getElementById(`${fileId}-progress-bar`);
                const progressText = document.getElementById(`${fileId}-progress-text`);
                const progressMB = document.getElementById(`${fileId}-progress-mb`);

                if (progressBar) progressBar.style.width = `${percent}%`;
                if (progressText) progressText.textContent = `${percent}%`;
                if (progressMB) progressMB.textContent = `${loadedMB} / ${totalMB} MB`;
              }
            };

            xhr.onload = () => {
              if (xhr.status >= 200 && xhr.status < 300) {
                try {
                  resolve(JSON.parse(xhr.responseText));
                } catch (e) {
                  reject(new Error('Invalid response'));
                }
              } else {
                try {
                  const errorData = JSON.parse(xhr.responseText);
                  reject(new Error(errorData.detail || `Upload failed (${xhr.status})`));
                } catch (e) {
                  reject(new Error(`Upload failed (${xhr.status})`));
                }
              }
            };

            xhr.onerror = () => {
              console.error('XHR onerror - status:', xhr.status, 'readyState:', xhr.readyState);
              reject(new Error('Network error during upload. Check your connection.'));
            };
            xhr.ontimeout = () => reject(new Error('Upload timed out after 10 minutes'));
            xhr.onabort = () => reject(new Error('Upload was cancelled'));

            // Log progress for debugging
            xhr.onloadend = () => {
              console.log('XHR complete - status:', xhr.status, 'response length:', xhr.responseText?.length || 0);
            };

            xhr.open('POST', '/upload');
            xhr.timeout = 600000; // 10 minute timeout for large files
            xhr.setRequestHeader('X-CSRF-Token', uploadCsrf);
            xhr.withCredentials = true;
            xhr.send(formData);
          });

          if (!uploadData.filename) {
            throw new Error(uploadData.detail || 'Upload failed');
          }

          // Update status element reference after innerHTML change
          const statusEl = document.querySelector(`#${fileId} .db-file-status`);

          // Step 2: Run full ML analysis (this caches insights for Q&A)
          statusEl.textContent = 'Running ML analysis...';

          try {
            const analyzeCsrf = document.cookie.split('; ').find(row => row.startsWith('ws_csrf='))?.split('=')[1] || '';
            const analyzeResponse = await fetch(`/analyze-full/${uploadData.filename}`, {
              method: 'POST',
              credentials: 'include',
              headers: { 'X-CSRF-Token': analyzeCsrf }
            });

            if (analyzeResponse.ok) {
              const analyzeData = await analyzeResponse.json();
              console.log('‚úÖ Full analysis complete:', analyzeData.analyses_run);
              statusEl.textContent = 'Analysis complete...';
            } else {
              console.warn('Full analysis failed, will use basic mode');
            }
          } catch (analyzeError) {
            console.warn('Analysis error (non-fatal):', analyzeError);
          }

          // Step 3: Create embeddings for semantic search (optional, runs in background)
          statusEl.textContent = 'Creating search index...';

          const embedCsrf = document.cookie.split('; ').find(row => row.startsWith('ws_csrf='))?.split('=')[1] || '';
          fetch('/embed', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': embedCsrf
            },
            credentials: 'include',
            body: JSON.stringify({ filename: uploadData.filename })
          }).then(r => {
            if (!r.ok) console.warn('Embedding creation failed, will use cached analysis');
          }).catch(e => console.warn('Embedding error:', e));

          // Step 4: Set as active database
          setActiveDatabase({
            filename: uploadData.filename,
            displayName: file.name,
            columns: uploadData.columns || [],
            isReady: true
          });

          statusEl.textContent = '‚úÖ Ready';
          statusEl.className = 'db-file-status complete';

          // Show Excel-like viewer with the uploaded data
          if (typeof DatabaseViewer !== 'undefined') {
            // For large files, show processing status
            const fileSizeMB = file.size / 1024 / 1024;
            if (fileSizeMB > 50) {
              statusEl.textContent = '‚è≥ Processing large database...';
              statusEl.className = 'db-file-status processing';
            }

            await DatabaseViewer.show(uploadData.filename, file.name);

            // Update status after loading
            statusEl.textContent = '‚úÖ Ready';
            statusEl.className = 'db-file-status complete';

            // Smooth scroll to viewer - use 'nearest' to avoid jumping if already visible
            const viewer = document.getElementById('database-excel-viewer');
            if (viewer) {
              // Only scroll if viewer is not already in viewport
              const rect = viewer.getBoundingClientRect();
              const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
              if (!isVisible) {
                viewer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              }
            }
          }

          // Also update the database indicator for RAG queries
          addChatMessage(`üìä Database "${file.name}" is ready! You can view the data above or switch to Chat to ask questions about it.`, 'ai');

          // Show Quality Analysis panel
          const qualityPanel = document.getElementById('quality-analysis-panel');
          if (qualityPanel) {
            qualityPanel.style.display = 'block';
            window.currentScoringFilename = uploadData.filename;
            if (lucide) lucide.createIcons();
          }

        } catch (error) {
          console.error('Upload error:', error);
          // Update the file item to show error state
          const fileItem = document.getElementById(fileId);
          if (fileItem) {
            const statusSpan = fileItem.querySelector('.db-file-status');
            if (statusSpan) {
              statusSpan.textContent = `Error: ${error.message}`;
              statusSpan.className = 'db-file-status pending';
            }
          }
        }
      }
    }

    // ================================================
    // Quality Analysis (Gemma Scoring)
    // ================================================
    let currentScoringJobId = null;
    let scoringPollInterval = null;

    async function startQualityAnalysis(testMode = false) {
      const filename = window.currentScoringFilename;
      if (!filename) {
        alert('Please upload a database first');
        return;
      }

      const chunkSize = document.getElementById('scoring-chunk-size')?.value || '20';
      const rowRange = document.getElementById('scoring-row-range')?.value || 'full';
      const progressSection = document.getElementById('scoring-progress-section');
      const resultsSection = document.getElementById('scoring-results-section');
      const btnStart = document.getElementById('btn-start-scoring');
      const btnTest = document.getElementById('btn-test-scoring');

      // Reset UI
      if (progressSection) progressSection.style.display = 'block';
      if (resultsSection) resultsSection.style.display = 'none';
      if (btnStart) btnStart.disabled = true;
      if (btnTest) btnTest.disabled = true;

      updateScoringProgress(0, 0, 0, -1, 0);
      document.querySelector('#scoring-status-text span').textContent = `Starting analysis (${rowRange})...`;

      try {
        const csrf = document.cookie.split('; ').find(row => row.startsWith('ws_csrf='))?.split('=')[1] || '';
        const endpoint = testMode
          ? `/database-scoring/test/${encodeURIComponent(filename)}`
          : `/database-scoring/score/${encodeURIComponent(filename)}`;

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf },
          credentials: 'include',
          body: JSON.stringify({
            chunk_size: parseInt(chunkSize),
            row_range: rowRange,
            test_mode: testMode
          })
        });

        if (!response.ok) {
          throw new Error(`Failed to start scoring: ${response.status}`);
        }

        const result = await response.json();
        currentScoringJobId = result.job_id;
        console.log('üìä Scoring job started:', currentScoringJobId);

        document.querySelector('#scoring-status-text span').textContent =
          `Processing ${result.total_chunks} chunks with Gemma...`;

        // Start polling
        pollScoringStatus();

      } catch (error) {
        console.error('Scoring error:', error);
        document.querySelector('#scoring-status-text span').textContent = `Error: ${error.message}`;
        if (btnStart) btnStart.disabled = false;
        if (btnTest) btnTest.disabled = false;
      }
    }

    async function pollScoringStatus() {
      if (!currentScoringJobId) return;

      try {
        const response = await fetch(`/database-scoring/status/${currentScoringJobId}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error(`Status check failed: ${response.status}`);
        }

        const status = await response.json();
        console.log('üìä Scoring status:', status.processed_chunks, '/', status.total_chunks);

        updateScoringProgress(
          status.processed_chunks,
          status.total_chunks,
          status.eta_ms,
          status.avg_overall || 0
        );

        if (status.status === 'complete') {
          console.log('‚úÖ Scoring complete');
          clearInterval(scoringPollInterval);
          currentScoringJobId = null;
          displayScoringResults(status);
          return;
        }

        if (status.status === 'failed') {
          document.querySelector('#scoring-status-text span').textContent = `Error: ${status.error}`;
          clearInterval(scoringPollInterval);
          document.getElementById('btn-start-scoring').disabled = false;
          document.getElementById('btn-test-scoring').disabled = false;
          return;
        }

        // Poll again
        scoringPollInterval = setTimeout(pollScoringStatus, 2000);

      } catch (error) {
        console.error('Poll error:', error);
        scoringPollInterval = setTimeout(pollScoringStatus, 3000);
      }
    }

    function updateScoringProgress(done, total, etaMs, avgScore) {
      const percent = total > 0 ? Math.round((done / total) * 100) : 0;
      const progressCircle = document.getElementById('scoring-progress-circle');
      const circumference = 2 * Math.PI * 54; // r=54

      if (progressCircle) {
        const offset = circumference - (percent / 100) * circumference;
        progressCircle.style.strokeDashoffset = offset;
      }

      document.getElementById('scoring-percent').textContent = `${percent}%`;
      document.getElementById('scoring-chunks-done').textContent = done.toLocaleString();
      document.getElementById('scoring-chunks-total').textContent = `/ ${total.toLocaleString()} chunks`;
      document.getElementById('scoring-avg').textContent = avgScore > 0 ? avgScore.toFixed(1) : '--';

      if (etaMs > 0) {
        document.getElementById('scoring-eta').textContent = formatETA(etaMs);
      } else if (etaMs === -1) {
        document.getElementById('scoring-eta').textContent = 'Calculating...';
      }

      document.querySelector('#scoring-status-text span').textContent =
        `Analyzing chunk ${done} of ${total}...`;
    }

    function formatETA(ms) {
      const seconds = Math.floor(ms / 1000);
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ${seconds % 60}s`;
      const hours = Math.floor(minutes / 60);
      return `${hours}h ${minutes % 60}m`;
    }

    async function displayScoringResults(status) {
      const progressSection = document.getElementById('scoring-progress-section');
      const resultsSection = document.getElementById('scoring-results-section');

      if (progressSection) progressSection.style.display = 'none';
      if (resultsSection) resultsSection.style.display = 'block';

      document.getElementById('btn-start-scoring').disabled = false;
      document.getElementById('btn-test-scoring').disabled = false;

      // Fetch full results
      try {
        const response = await fetch(`/database-scoring/results/${status.job_id}`, {
          credentials: 'include'
        });

        if (response.ok) {
          const results = await response.json();
          const summary = results.summary || {};

          // Update score cards with new Q1-Q5 format
          const dimensions = ['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'overall'];
          dimensions.forEach(dim => {
            const card = document.querySelector(`.score-card[data-dimension="${dim}"]`);
            if (card) {
              const value = summary[`avg_${dim}`] || 0;
              card.querySelector('.score-value').textContent = value.toFixed(1);
              const fill = card.querySelector('.score-fill');
              if (fill) {
                fill.style.width = `${value * 10}%`;
              }
            }
          });

          console.log('üìä Final scores:', summary);

          // Calculate insights filename from original
          const originalFilename = currentScoringFilename || results.filename || '';
          const baseName = originalFilename.replace(/\.[^/.]+$/, '');
          const insightsFilename = `${baseName}_insights.csv`;

          // Show message about enhanced database
          const statusText = document.querySelector('#scoring-status-text span');
          if (statusText) {
            statusText.innerHTML = `‚úÖ Complete! Loading enhanced database with score columns...`;
          }

          // Reload database list to show the new insights file
          await loadSavedDatabases();

          console.log('üìÅ Insights database created:', insightsFilename);

          // AUTO-SWITCH: Find and display the insights file
          // Wait a moment for database list to update, then switch to insights file
          setTimeout(async () => {
            try {
              const dbResponse = await fetch('/databases', { credentials: 'include' });
              if (dbResponse.ok) {
                const dbData = await dbResponse.json();
                // Find the insights file in the database list
                const insightsDb = dbData.databases.find(db => db.filename.includes('_insights'));
                if (insightsDb) {
                  console.log('üìä Auto-switching to insights database:', insightsDb.filename);
                  // Auto-select the insights database to show score columns
                  selectDatabase(insightsDb.filename, insightsDb.display_name || insightsFilename);

                  if (statusText) {
                    statusText.innerHTML = `‚úÖ Showing enhanced database with Gemma score columns!`;
                  }

                  // üèîÔ∏è TRIGGER 3D QUALITY DASHBOARD
                  console.log('üèîÔ∏è Launching 3D Quality Intelligence Dashboard...');
                  setTimeout(() => {
                    showQuality3D(insightsFilename);
                  }, 800);
                }
              }
            } catch (e) {
              console.warn('Could not auto-switch to insights database:', e);
            }
          }, 500);
        }
      } catch (error) {
        console.error('Failed to fetch results:', error);
      }
    }

    // ================================================
    // Saved Databases Management
    // ================================================
    async function loadSavedDatabases(retryCount = 0) {
      const MAX_RETRIES = 3;
      const container = document.getElementById('existing-databases');
      if (!container) return;

      try {
        const response = await fetch('/databases', { credentials: 'include' });
        if (!response.ok) {
          container.innerHTML = '<p class="text-muted">Could not load databases.</p>';
          return;
        }

        const data = await response.json();

        if (!data.databases || data.databases.length === 0) {
          container.innerHTML = '<p class="text-muted">No databases uploaded yet. Upload a CSV to get started!</p>';
          return;
        }

        container.innerHTML = `
          <div class="saved-db-list">
            ${data.databases.map(db => `
              <div class="saved-db-item ${activeDatabase?.filename === db.filename ? 'active' : ''}">
                <div class="db-info">
                  <i data-lucide="${db.has_embeddings ? 'database' : 'file'}" style="width: 18px; height: 18px; color: ${db.has_embeddings ? 'var(--primary)' : 'var(--text-muted)'};"></i>
                  <div>
                    <div class="db-name">${db.display_name}</div>
                    <div class="db-meta">${(db.size_bytes / 1024).toFixed(1)} KB ${db.has_embeddings ? '‚Ä¢ Indexed' : ''}</div>
                  </div>
                </div>
                <div class="db-actions">
                  ${db.has_embeddings
            ? `<button class="btn-use" onclick="selectDatabase('${db.filename}', '${db.display_name.replace(/'/g, "\\'")}')">
                         ${activeDatabase?.filename === db.filename ? '‚úì Active' : 'Use'}
                       </button>`
            : `<button class="btn-embed" onclick="embedDatabase('${db.filename}', this)">Index</button>`
          }
                </div>
              </div>
            `).join('')}
          </div>
        `;

        lucide.createIcons();

      } catch (error) {
        // Retry on network errors
        if (retryCount < MAX_RETRIES && (error.name === 'TypeError' || error.message?.includes('NetworkError'))) {
          console.warn(`Network error loading databases, retry ${retryCount + 1}/${MAX_RETRIES}...`);
          await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
          return loadSavedDatabases(retryCount + 1);
        }
        console.error('Error loading databases:', error);
        container.innerHTML = '<p class="text-muted">Error loading databases. <a href="#" onclick="loadSavedDatabases()">Retry</a></p>';
      }
    }

    function selectDatabase(filename, displayName) {
      setActiveDatabase({
        filename,
        displayName,
        columns: [],
        isReady: true
      });

      // Show the database viewer inline
      if (typeof DatabaseViewer !== 'undefined') {
        DatabaseViewer.show(filename, displayName);
        // Scroll to the viewer
        const viewer = document.getElementById('database-excel-viewer');
        if (viewer) {
          viewer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      addChatMessage(`üìä Switched to database "${displayName}". View the data above or ask me anything about it!`, 'ai');
    }

    async function embedDatabase(filename, buttonEl) {
      if (buttonEl) {
        buttonEl.disabled = true;
        buttonEl.textContent = 'Indexing...';
      }

      try {
        const response = await fetch('/embed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ filename })
        });

        if (response.ok) {
          loadSavedDatabases(); // Refresh list
        } else {
          const data = await response.json().catch(() => ({}));
          alert(`Failed to create index: ${data.detail || 'Unknown error'}`);
          if (buttonEl) {
            buttonEl.disabled = false;
            buttonEl.textContent = 'Index';
          }
        }
      } catch (error) {
        console.error('Embed error:', error);
        alert('Failed to create index. Please try again.');
        if (buttonEl) {
          buttonEl.disabled = false;
          buttonEl.textContent = 'Index';
        }
      }
    }

    // Make functions available globally
    window.sendChatMessage = sendChatMessage;
    window.useQuickPrompt = useQuickPrompt;
    window.handleDatabaseUpload = handleDatabaseUpload;
    window.selectDatabase = selectDatabase;
    window.embedDatabase = embedDatabase;
    window.clearActiveDatabase = clearActiveDatabase;

    // Start when DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', async () => {
        initPage();
        initTabs();
        initDatabaseUpload();
        await restoreActiveDatabase();
        loadSavedDatabases();
      });
    } else {
      initPage();
      initTabs();
      initDatabaseUpload();
      restoreActiveDatabase().then(() => loadSavedDatabases());
    }
  </script>

  <!-- Mobile Navigation -->
  <script src="assets/js/nav.js"></script>

</body>

</html>