<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Premium Financial Analytics Dashboard - Enterprise AI/ML Platform">
    <title>Financial Analytics | Titan Enterprise</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

    <!-- Financial Charts Modules -->
    <script src="assets/js/financial-charts-core.js"></script>
    <script src="assets/js/financial-charts-flow.js"></script>
    <script src="assets/js/financial-charts-kpi.js"></script>
    <script src="assets/js/financial-charts-advanced.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/financial-premium.css">

    <style>
        /* Page-specific overrides */
        .upload-zone {
            border: 2px dashed var(--fin-border);
            border-radius: var(--fin-radius-lg);
            padding: var(--fin-space-2xl);
            text-align: center;
            cursor: pointer;
            transition: all var(--fin-transition-normal);
            background: rgba(99, 102, 241, 0.02);
        }

        .upload-zone:hover {
            border-color: var(--fin-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-zone.dragover {
            border-color: var(--fin-primary);
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.01);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: var(--fin-space-md);
        }

        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--fin-border), transparent);
            margin: var(--fin-space-xl) 0;
        }

        .engine-category {
            margin-bottom: var(--fin-space-lg);
        }

        .engine-category-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--fin-text-muted);
            margin-bottom: var(--fin-space-md);
            display: flex;
            align-items: center;
            gap: var(--fin-space-sm);
        }

        .results-placeholder {
            text-align: center;
            padding: var(--fin-space-2xl);
            color: var(--fin-text-muted);
        }

        .results-placeholder-icon {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: var(--fin-space-md);
        }
    </style>
    <script src="assets/js/mock_data.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/offline-banner.js"></script>
</head>

<body class="fin-dashboard">
    <style>
        .demo-mode-banner {
            background: linear-gradient(90deg, #FF6B6B, #FF8E53);
            color: white;
            text-align: center;
            padding: 8px;
            font-weight: bold;
            font-family: 'Inter', sans-serif;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 99999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        body {
            margin-top: 40px !important;
        }

        .vox-nav {
            top: 40px !important;
        }
    </style>
    <div class="demo-mode-banner">
        ‚ö†Ô∏è DEMO MODE - Static Data Simulation
    </div>
    <div class="fin-container">
        <!-- Header -->
        <header class="fin-header">
            <div>
                <h1 class="fin-header-title">üíé Financial Analytics</h1>
                <p class="fin-header-subtitle">Enterprise-grade financial analysis powered by 12 AI engines</p>
            </div>
            <div class="fin-flex fin-gap-sm">
                <button class="fin-btn fin-btn-secondary" onclick="window.location.href='nexus.html'">
                    ‚Üê Back to ML Service
                </button>
            </div>
        </header>

        <!-- Upload Section -->
        <section class="fin-card fin-mb-lg" id="upload-section">
            <div class="fin-card-title">
                <span class="fin-card-title-icon">üìÇ</span>
                Upload Financial Data
            </div>
            <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
                <div class="upload-icon">üìä</div>
                <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: var(--fin-space-sm);">
                    Drop your financial dataset here
                </div>
                <div style="color: var(--fin-text-muted); font-size: 0.9rem;">
                    CSV, Excel ‚Ä¢ Max 50MB ‚Ä¢ Revenue, costs, transactions, budgets
                </div>
            </div>
            <input type="file" id="file-input" accept=".csv,.xlsx,.xls" style="display: none;">

            <div class="fin-flex fin-justify-between fin-items-center fin-mt-lg">
                <div id="file-info" style="color: var(--fin-text-muted); font-size: 0.85rem;">
                    No file selected
                </div>
                <button class="fin-btn fin-btn-primary fin-btn-lg" id="analyze-btn" disabled>
                    ‚ö° Run Financial Analysis
                </button>
            </div>

            <!-- Progress -->
            <div id="progress-section" class="fin-hidden fin-mt-lg">
                <div class="fin-flex fin-justify-between fin-mb-sm">
                    <span id="progress-status" style="color: var(--fin-text-secondary);">Initializing...</span>
                    <span id="progress-percent" style="color: var(--fin-primary); font-weight: 600;">0%</span>
                </div>
                <div style="height: 8px; background: rgba(99, 102, 241, 0.1); border-radius: 4px; overflow: hidden;">
                    <div id="progress-bar"
                        style="height: 100%; width: 0%; background: var(--fin-gradient-primary); transition: width 0.3s ease;">
                    </div>
                </div>
            </div>
        </section>

        <!-- Engine Selection -->
        <section class="fin-card fin-mb-lg" id="engine-section">
            <div class="fin-card-title">
                <span class="fin-card-title-icon">üéØ</span>
                Financial Engines
            </div>
            <p class="fin-card-subtitle">
                Select engines to analyze your financial data. Each engine provides specialized insights.
            </p>

            <div class="fin-tabs" id="engine-tabs">
                <button class="fin-tab active" onclick="filterEngines('all')">
                    <span class="fin-tab-icon">üìä</span> All Engines
                </button>
                <button class="fin-tab" onclick="filterEngines('revenue')">
                    <span class="fin-tab-icon">üí∞</span> Revenue
                </button>
                <button class="fin-tab" onclick="filterEngines('cost')">
                    <span class="fin-tab-icon">üí∏</span> Costs
                </button>
                <button class="fin-tab" onclick="filterEngines('forecast')">
                    <span class="fin-tab-icon">üîÆ</span> Forecasting
                </button>
                <button class="fin-tab" onclick="filterEngines('customer')">
                    <span class="fin-tab-icon">üë•</span> Customers
                </button>
            </div>

            <div class="fin-engine-grid fin-stagger" id="engine-grid">
                <!-- Populated by JavaScript -->
            </div>

            <div class="fin-flex fin-justify-between fin-items-center fin-mt-lg">
                <span id="selected-count" style="color: var(--fin-text-muted);">0 engines selected</span>
                <div class="fin-flex fin-gap-sm">
                    <button class="fin-btn fin-btn-secondary" onclick="selectAllEngines()">Select All</button>
                    <button class="fin-btn fin-btn-secondary" onclick="clearEngines()">Clear</button>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="fin-hidden">
            <!-- KPI Hero Row -->
            <div class="fin-grid fin-grid-kpi fin-mb-lg fin-stagger" id="kpi-row">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Results Tabs -->
            <div class="fin-tabs" id="results-tabs">
                <button class="fin-tab active" onclick="showResultsTab('overview')">
                    <span class="fin-tab-icon">üìä</span> Overview
                </button>
                <button class="fin-tab" onclick="showResultsTab('cashflow')">
                    <span class="fin-tab-icon">üí∏</span> Cash Flow
                </button>
                <button class="fin-tab" onclick="showResultsTab('variance')">
                    <span class="fin-tab-icon">üìã</span> Variance
                </button>
                <button class="fin-tab" onclick="showResultsTab('forecast')">
                    <span class="fin-tab-icon">üîÆ</span> Forecast
                </button>
                <button class="fin-tab" onclick="showResultsTab('advanced')">
                    <span class="fin-tab-icon">üß™</span> Advanced
                </button>
            </div>

            <!-- Overview Tab -->
            <div class="fin-tab-content active" id="tab-overview">
                <div class="fin-grid fin-grid-main fin-gap-lg">
                    <!-- Main Charts -->
                    <div class="fin-flex fin-flex-col fin-gap-lg">
                        <div class="fin-card">
                            <div class="fin-card-title">
                                <span class="fin-card-title-icon">üìä</span>
                                Financial Health Gauges
                            </div>
                            <div class="fin-chart-container" id="gauge-cluster-chart" style="height: 250px;"></div>
                        </div>

                        <div class="fin-card">
                            <div class="fin-card-title">
                                <span class="fin-card-title-icon">üéØ</span>
                                Budget vs Actual
                            </div>
                            <div class="fin-chart-container" id="bullet-chart"></div>
                        </div>
                    </div>

                    <!-- Insights Sidebar -->
                    <div class="fin-card">
                        <div class="fin-card-title">
                            <span class="fin-card-title-icon">üí°</span>
                            Key Insights
                        </div>
                        <div class="fin-insights fin-scrollbar" id="insights-feed"
                            style="max-height: 500px; overflow-y: auto;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cash Flow Tab -->
            <div class="fin-tab-content" id="tab-cashflow">
                <div class="fin-grid fin-grid-2 fin-gap-lg">
                    <div class="fin-card">
                        <div class="fin-card-title">
                            <span class="fin-card-title-icon">üåä</span>
                            Cash Flow Sankey
                        </div>
                        <p class="fin-card-subtitle">
                            Visualize how money flows through your business
                        </p>
                        <div class="fin-chart-container-lg" id="sankey-chart"></div>
                    </div>

                    <div class="fin-card">
                        <div class="fin-card-title">
                            <span class="fin-card-title-icon">üìà</span>
                            Cash Position Over Time
                        </div>
                        <div class="fin-chart-container" id="cashflow-combo-chart"></div>
                    </div>
                </div>
            </div>

            <!-- Variance Tab -->
            <div class="fin-tab-content" id="tab-variance">
                <div class="fin-grid fin-grid-2 fin-gap-lg">
                    <div class="fin-card">
                        <div class="fin-card-title">
                            <span class="fin-card-title-icon">üìä</span>
                            Budget Variance Waterfall
                        </div>
                        <p class="fin-card-subtitle">
                            See where you're over or under budget
                        </p>
                        <div class="fin-chart-container" id="waterfall-chart"></div>
                    </div>

                    <div class="fin-card">
                        <div class="fin-card-title">
                            <span class="fin-card-title-icon">üå™Ô∏è</span>
                            Sensitivity Analysis
                        </div>
                        <p class="fin-card-subtitle">
                            Which factors impact your bottom line most?
                        </p>
                        <div class="fin-chart-container" id="tornado-chart"></div>
                    </div>
                </div>
            </div>

            <!-- Forecast Tab -->
            <div class="fin-tab-content" id="tab-forecast">
                <!-- 3D Financial Visualization -->
                <div class="fin-card fin-mb-lg">
                    <div class="fin-card-title">
                        <span class="fin-card-title-icon">üìä</span>
                        3D Financial Forecast Visualization
                    </div>
                    <div class="scene-shell" id="financial-viz"
                        style="height: 350px; border-radius: var(--fin-radius-lg); overflow: hidden;"></div>
                </div>

                <div class="fin-grid fin-grid-main fin-gap-lg">
                    <div class="fin-card">
                        <div class="fin-card-title">
                            <span class="fin-card-title-icon">üîÆ</span>
                            Revenue Forecast
                        </div>
                        <p class="fin-card-subtitle">
                            Predicted revenue with confidence intervals
                        </p>
                        <div class="fin-chart-container-lg" id="forecast-chart"></div>
                    </div>

                    <div class="fin-flex fin-flex-col fin-gap-lg">
                        <div class="fin-card">
                            <div class="fin-card-title">
                                <span class="fin-card-title-icon">üë•</span>
                                Customer LTV Segments
                            </div>
                            <div class="fin-chart-container" id="radar-chart" style="height: 280px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Tab -->
            <div class="fin-tab-content" id="tab-advanced">
                <div class="fin-grid fin-grid-2 fin-gap-lg">
                    <div class="fin-card">
                        <div class="fin-card-title">
                            <span class="fin-card-title-icon">üóÇÔ∏è</span>
                            Cost Composition Treemap
                        </div>
                        <div class="fin-chart-container-lg" id="treemap-chart"></div>
                    </div>

                    <div class="fin-card">
                        <div class="fin-card-title">
                            <span class="fin-card-title-icon">üï∏Ô∏è</span>
                            Product Associations
                        </div>
                        <p class="fin-card-subtitle">
                            Market basket analysis - which products are bought together
                        </p>
                        <div class="fin-chart-container-lg" id="network-chart"></div>
                    </div>
                </div>

                <div class="fin-card fin-mt-lg">
                    <div class="fin-card-title">
                        <span class="fin-card-title-icon">üìê</span>
                        Pricing Optimization Surface
                    </div>
                    <p class="fin-card-subtitle">
                        3D visualization of optimal price-quantity relationship
                    </p>
                    <div class="fin-chart-container-xl" id="surface-chart"></div>
                </div>
            </div>
        </section>

        <!-- Placeholder when no results -->
        <section class="fin-card" id="results-placeholder">
            <div class="results-placeholder">
                <div class="results-placeholder-icon">üìà</div>
                <h3 style="color: var(--fin-text-secondary); margin-bottom: var(--fin-space-sm);">
                    Ready for Financial Analysis
                </h3>
                <p style="max-width: 400px; margin: 0 auto; line-height: 1.6; margin-bottom: var(--fin-space-lg);">
                    Upload a financial dataset to unlock premium visualizations including
                    Sankey diagrams, waterfall charts, 3D surfaces, and more.
                </p>
                <button class="fin-btn fin-btn-primary fin-btn-lg" onclick="runDemoMode()">
                    üé¨ View Demo with Sample Data
                </button>
            </div>
        </section>
    </div>

    <script>
        // =============================================================================
        // CONFIGURATION
        // =============================================================================

        const API_BASE = window.location.origin;

        const FINANCIAL_ENGINES = [
            { id: 'cost_optimization', name: 'Cost Optimization', icon: 'üí∞', category: 'cost', description: 'Identify cost reduction opportunities with Pareto analysis' },
            { id: 'roi_prediction', name: 'ROI Prediction', icon: 'üìà', category: 'revenue', description: 'Predict return on investment with NPV and payback analysis' },
            { id: 'spend_patterns', name: 'Spend Patterns', icon: 'üí≥', category: 'cost', description: 'Analyze spending trends, anomalies, and seasonality' },
            { id: 'budget_variance', name: 'Budget Variance', icon: 'üìã', category: 'cost', description: 'Compare budgets vs actuals with variance analysis' },
            { id: 'profit_margins', name: 'Profit Margins', icon: 'üíµ', category: 'revenue', description: 'Analyze margins by product, customer, and segment' },
            { id: 'revenue_forecasting', name: 'Revenue Forecast', icon: 'üîÆ', category: 'forecast', description: 'Predict future revenue with confidence intervals' },
            { id: 'customer_ltv', name: 'Customer LTV', icon: 'üë•', category: 'customer', description: 'Calculate lifetime value and segment customers' },
            { id: 'cash_flow', name: 'Cash Flow', icon: 'üí∏', category: 'cost', description: 'Analyze cash position, runway, and burn rate' },
            { id: 'inventory_optimization', name: 'Inventory', icon: 'üì¶', category: 'cost', description: 'ABC analysis, reorder points, and EOQ calculation' },
            { id: 'pricing_strategy', name: 'Pricing Strategy', icon: 'üè∑Ô∏è', category: 'revenue', description: 'Price elasticity and competitive analysis' },
            { id: 'market_basket', name: 'Market Basket', icon: 'üõí', category: 'customer', description: 'Association rules and cross-sell opportunities' },
            { id: 'resource_utilization', name: 'Resource Usage', icon: '‚öôÔ∏è', category: 'cost', description: 'Identify bottlenecks and underutilized resources' }
        ];

        let uploadedFilename = null;
        let selectedEngines = new Set();
        let analysisResults = {};

        // =============================================================================
        // INITIALIZATION
        // =============================================================================

        document.addEventListener('DOMContentLoaded', () => {
            renderEngineGrid();
            setupFileUpload();
        });

        function renderEngineGrid() {
            const grid = document.getElementById('engine-grid');
            grid.innerHTML = FINANCIAL_ENGINES.map(engine => `
                <div class="fin-engine-card" 
                     data-engine="${engine.id}" 
                     data-category="${engine.category}"
                     onclick="toggleEngine('${engine.id}')">
                    <div class="fin-engine-status"></div>
                    <div class="fin-engine-header">
                        <span class="fin-engine-icon">${engine.icon}</span>
                        <span class="fin-engine-name">${engine.name}</span>
                    </div>
                    <div class="fin-engine-description">${engine.description}</div>
                </div>
            `).join('');
        }

        function toggleEngine(id) {
            const card = document.querySelector(`[data-engine="${id}"]`);
            if (selectedEngines.has(id)) {
                selectedEngines.delete(id);
                card.classList.remove('selected');
            } else {
                selectedEngines.add(id);
                card.classList.add('selected');
            }
            updateSelectedCount();
        }

        function selectAllEngines() {
            FINANCIAL_ENGINES.forEach(e => {
                selectedEngines.add(e.id);
                document.querySelector(`[data-engine="${e.id}"]`).classList.add('selected');
            });
            updateSelectedCount();
        }

        function clearEngines() {
            selectedEngines.clear();
            document.querySelectorAll('.fin-engine-card').forEach(c => c.classList.remove('selected'));
            updateSelectedCount();
        }

        function filterEngines(category) {
            // Update tab active state
            document.querySelectorAll('#engine-tabs .fin-tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.fin-tab').classList.add('active');

            // Show/hide engines
            document.querySelectorAll('.fin-engine-card').forEach(card => {
                if (category === 'all' || card.dataset.category === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = `${selectedEngines.size} engines selected`;
        }

        // =============================================================================
        // FILE UPLOAD
        // =============================================================================

        function setupFileUpload() {
            const zone = document.getElementById('upload-zone');
            const input = document.getElementById('file-input');

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });

            input.addEventListener('change', () => {
                if (input.files.length > 0) {
                    handleFile(input.files[0]);
                }
            });
        }

        async function handleFile(file) {
            const fileInfo = document.getElementById('file-info');
            const analyzeBtn = document.getElementById('analyze-btn');

            fileInfo.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;

            // Upload file
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await res.json();
                if (data.success) {
                    uploadedFilename = data.filename;
                    analyzeBtn.disabled = false;
                    analyzeBtn.onclick = runAnalysis;
                    fileInfo.innerHTML = `‚úÖ ${file.name} ‚Ä¢ ${data.rows?.toLocaleString() || '?'} rows ‚Ä¢ ${data.columns?.length || '?'} columns`;
                } else {
                    fileInfo.textContent = `‚ùå Upload failed: ${data.error}`;
                }
            } catch (err) {
                fileInfo.textContent = `‚ùå Upload error: ${err.message}`;
            }
        }

        // =============================================================================
        // ANALYSIS
        // =============================================================================

        async function runAnalysis() {
            if (!uploadedFilename) return;
            if (selectedEngines.size === 0) {
                alert('Please select at least one engine');
                return;
            }

            const progressSection = document.getElementById('progress-section');
            const progressBar = document.getElementById('progress-bar');
            const progressStatus = document.getElementById('progress-status');
            const progressPercent = document.getElementById('progress-percent');
            const analyzeBtn = document.getElementById('analyze-btn');

            progressSection.classList.remove('fin-hidden');
            analyzeBtn.disabled = true;

            const engines = Array.from(selectedEngines);
            analysisResults = {};
            let completed = 0;

            for (const engineId of engines) {
                progressStatus.textContent = `Running ${engineId.replace(/_/g, ' ')}...`;

                try {
                    const res = await fetch(`${API_BASE}/analytics/standard/${engineId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ filename: uploadedFilename })
                    });

                    const data = await res.json();
                    analysisResults[engineId] = data;
                } catch (err) {
                    analysisResults[engineId] = { error: err.message };
                }

                completed++;
                const pct = Math.round((completed / engines.length) * 100);
                progressBar.style.width = `${pct}%`;
                progressPercent.textContent = `${pct}%`;
            }

            progressStatus.textContent = 'Analysis complete!';
            analyzeBtn.disabled = false;

            // Show results
            displayResults();
        }

        // =============================================================================
        // DISPLAY RESULTS
        // =============================================================================

        function displayResults() {
            document.getElementById('results-placeholder').classList.add('fin-hidden');
            document.getElementById('results-section').classList.remove('fin-hidden');

            renderKPIRow();
            renderGaugeCluster();
            renderBulletChart();
            renderInsightsFeed();
            renderCashFlowCharts();
            renderVarianceCharts();
            renderForecastCharts();
            renderAdvancedCharts();
        }

        function renderKPIRow() {
            const row = document.getElementById('kpi-row');

            // Extract metrics from results
            const cashFlow = analysisResults.cash_flow || {};
            const profitMargins = analysisResults.profit_margins || {};
            const customerLtv = analysisResults.customer_ltv || {};
            const revenueForecasting = analysisResults.revenue_forecasting || {};

            const kpis = [
                {
                    icon: 'üí∞',
                    label: 'Total Revenue',
                    value: profitMargins.total_revenue || revenueForecasting.historical_total || 1250000,
                    trend: 12.5,
                    variant: 'success'
                },
                {
                    icon: 'üìä',
                    label: 'Profit Margin',
                    value: profitMargins.average_margin || 24.5,
                    format: 'percent',
                    trend: 3.2,
                    variant: 'info'
                },
                {
                    icon: 'üí∏',
                    label: 'Cash Runway',
                    value: cashFlow.runway_months || 14.5,
                    format: 'months',
                    trend: -2.1,
                    variant: 'warning'
                },
                {
                    icon: 'üë•',
                    label: 'Avg Customer LTV',
                    value: customerLtv.avg_clv || 2450,
                    trend: 8.7,
                    variant: 'success'
                }
            ];

            row.innerHTML = kpis.map(kpi => `
                <div class="fin-kpi fin-kpi-${kpi.variant}">
                    <div class="fin-kpi-icon">${kpi.icon}</div>
                    <div class="fin-kpi-label">${kpi.label}</div>
                    <div class="fin-kpi-value fin-animate-number" data-value="${kpi.value}" data-format="${kpi.format || 'currency'}">
                        ${formatValue(kpi.value, kpi.format)}
                    </div>
                    <div class="fin-kpi-trend ${kpi.trend >= 0 ? 'fin-kpi-trend-up' : 'fin-kpi-trend-down'}">
                        ${kpi.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(kpi.trend)}%
                        <span class="fin-kpi-trend-label">vs last period</span>
                    </div>
                </div>
            `).join('');
        }

        function formatValue(value, format) {
            if (format === 'percent') return `${value.toFixed(1)}%`;
            if (format === 'months') return `${value.toFixed(1)} mo`;
            // Safe fallback for FinancialUtils
            if (typeof FinancialUtils !== 'undefined' && FinancialUtils.formatCurrency) {
                return FinancialUtils.formatCurrency(value, 'USD', true);
            }
            // Manual fallback
            return '$' + value.toLocaleString();
        }

        function renderGaugeCluster() {
            const cashFlow = analysisResults.cash_flow || {};
            const profitMargins = analysisResults.profit_margins || {};
            const resourceUtil = analysisResults.resource_utilization || {};

            GaugeCluster.createFinancialHealth('gauge-cluster-chart', {
                cashRunway: cashFlow.runway_months || 14,
                profitMargin: profitMargins.average_margin || 25,
                revenueGrowth: 18,
                churnRate: 8
            });
        }

        function renderBulletChart() {
            const budgetVariance = analysisResults.budget_variance || {};

            const departments = [
                { name: 'Marketing', actual: 125000, budget: 150000 },
                { name: 'Engineering', actual: 280000, budget: 250000 },
                { name: 'Sales', actual: 95000, budget: 100000 },
                { name: 'Operations', actual: 180000, budget: 175000 }
            ];

            BulletChart.createBudgetComparison('bullet-chart', departments);
        }

        function renderInsightsFeed() {
            const feed = document.getElementById('insights-feed');

            const insights = [
                { type: 'success', icon: '‚úÖ', title: 'Healthy Profit Margins', text: 'Your average profit margin of 24.5% exceeds industry benchmarks by 8%.' },
                { type: 'warning', icon: '‚ö†Ô∏è', title: 'Engineering Over Budget', text: 'Engineering department is 12% over budget. Consider reviewing project scope.' },
                { type: 'info', icon: 'üí°', title: 'Cross-Sell Opportunity', text: 'Customers buying Product A are 3x more likely to buy Product B.' },
                { type: 'success', icon: 'üìà', title: 'Revenue Growth', text: 'Revenue is projected to grow 18% next quarter based on current trends.' },
                { type: 'danger', icon: 'üî¥', title: 'Cash Runway Alert', text: 'At current burn rate, runway is 14.5 months. Consider cost optimization.' }
            ];

            feed.innerHTML = insights.map(i => `
                <div class="fin-insight fin-insight-${i.type}">
                    <span class="fin-insight-icon">${i.icon}</span>
                    <div class="fin-insight-content">
                        <div class="fin-insight-title">${i.title}</div>
                        <div class="fin-insight-text">${i.text}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderCashFlowCharts() {
            // Sankey
            SankeyChart.createCashFlow('sankey-chart', {
                inflows: {
                    'Product Sales': 450000,
                    'Services': 180000,
                    'Subscriptions': 120000,
                    'Other Income': 25000
                },
                outflows: {
                    'Salaries': 320000,
                    'Marketing': 85000,
                    'Infrastructure': 65000,
                    'R&D': 95000,
                    'Admin': 45000
                },
                totalInflows: 775000,
                totalOutflows: 610000
            });

            // Combo chart
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const netFlows = [25000, -15000, 45000, 30000, -20000, 55000, 40000, -10000, 60000, 35000, 25000, 50000];

            let balance = 100000;
            const balances = netFlows.map(flow => {
                balance += flow;
                return balance;
            });

            ComboFlowChart.create('cashflow-combo-chart', {
                labels: months,
                barValues: netFlows,
                lineValues: balances,
                title: 'Monthly Cash Flow'
            });
        }

        function renderVarianceCharts() {
            // Waterfall
            WaterfallChart.createBudgetVariance('waterfall-chart',
                [150000, 250000, 100000, 175000],
                [125000, 280000, 95000, 180000],
                ['Marketing', 'Engineering', 'Sales', 'Operations']
            );

            // Tornado
            TornadoChart.create('tornado-chart', {
                factors: ['Price', 'Volume', 'COGS', 'Marketing Spend', 'Churn Rate'],
                lowImpact: [-85000, -120000, -45000, -30000, -55000],
                highImpact: [95000, 150000, 35000, 60000, 40000],
                title: 'Profit Sensitivity Analysis'
            });
        }

        function renderForecastCharts() {
            // Revenue forecast
            const historical = {
                x: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                y: [180000, 195000, 210000, 225000, 240000, 260000]
            };

            const forecast = {
                x: ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                y: [280000, 300000, 320000, 345000, 370000, 400000],
                upper: [310000, 340000, 370000, 405000, 440000, 480000],
                lower: [250000, 260000, 270000, 285000, 300000, 320000]
            };

            ForecastAreaChart.create('forecast-chart', {
                historical,
                forecast,
                forecastStart: 'Jul',
                title: 'Revenue Forecast with Confidence Bands'
            });

            // RFM Radar
            RadarChart.createRFM('radar-chart', [
                { name: 'VIP Customers', recency: 90, frequency: 85, monetary: 95 },
                { name: 'At-Risk', recency: 30, frequency: 60, monetary: 70 },
                { name: 'New Customers', recency: 95, frequency: 25, monetary: 40 }
            ]);
        }

        function renderAdvancedCharts() {
            // Treemap
            TreemapChart.createCostComposition('treemap-chart', {
                'Salaries': {
                    subcategories: {
                        'Engineering': 180000,
                        'Sales': 85000,
                        'Marketing': 55000,
                        'Admin': 40000
                    }
                },
                'Infrastructure': {
                    subcategories: {
                        'Cloud Services': 45000,
                        'Office': 35000,
                        'Equipment': 25000
                    }
                },
                'Marketing': {
                    subcategories: {
                        'Digital Ads': 50000,
                        'Events': 25000,
                        'Content': 15000
                    }
                }
            });

            // Network graph
            NetworkGraph.createMarketBasket('network-chart', [
                { antecedent: 'Laptop', consequent: 'Mouse', support: 0.15, confidence: 0.7, lift: 2.3 },
                { antecedent: 'Laptop', consequent: 'Keyboard', support: 0.12, confidence: 0.6, lift: 2.1 },
                { antecedent: 'Mouse', consequent: 'Mousepad', support: 0.18, confidence: 0.8, lift: 3.2 },
                { antecedent: 'Monitor', consequent: 'HDMI Cable', support: 0.22, confidence: 0.75, lift: 2.8 },
                { antecedent: 'Keyboard', consequent: 'Wrist Rest', support: 0.08, confidence: 0.45, lift: 1.9 },
                { antecedent: 'Laptop', consequent: 'Bag', support: 0.25, confidence: 0.65, lift: 2.0 }
            ]);

            // 3D Surface
            SurfaceChart.createFromElasticity('surface-chart', 100, 1000, -1.5);
        }

        // =============================================================================
        // TAB SWITCHING
        // =============================================================================

        function showResultsTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('#results-tabs .fin-tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.fin-tab').classList.add('active');

            // Show/hide content
            document.querySelectorAll('.fin-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // =============================================================================
        // DEMO MODE - Show charts with sample data
        // =============================================================================

        function runDemoMode() {
            console.log('üé¨ Starting Demo Mode...');

            // Hide placeholder, show results
            document.getElementById('results-placeholder').classList.add('fin-hidden');
            document.getElementById('results-section').classList.remove('fin-hidden');

            // Use sample data for all visualizations
            analysisResults = {
                cash_flow: { runway_months: 14.5, runway_change: -2.1 },
                profit_margins: { average_margin: 24.5, total_revenue: 1250000, margin_trend: 3.2 },
                customer_ltv: { avg_clv: 2450, ltv_growth: 8.7 },
                revenue_forecasting: { historical_total: 1250000, growth_rate: 18 },
                budget_variance: { over_budget_categories: ['Engineering'] },
                market_basket: { rules: [{ antecedent: 'Laptop', consequent: 'Mouse', lift: 2.3 }] }
            };

            // Render all charts with demo data
            try {
                renderKPIRow();
                console.log('‚úÖ KPI Row rendered');
            } catch (e) { console.error('KPI Row error:', e); }

            try {
                renderGaugeCluster();
                console.log('‚úÖ Gauge Cluster rendered');
            } catch (e) { console.error('Gauge Cluster error:', e); }

            try {
                renderBulletChart();
                console.log('‚úÖ Bullet Chart rendered');
            } catch (e) { console.error('Bullet Chart error:', e); }

            try {
                renderInsightsFeed();
                console.log('‚úÖ Insights Feed rendered');
            } catch (e) { console.error('Insights Feed error:', e); }

            try {
                renderCashFlowCharts();
                console.log('‚úÖ Cash Flow Charts rendered');
            } catch (e) { console.error('Cash Flow error:', e); }

            try {
                renderVarianceCharts();
                console.log('‚úÖ Variance Charts rendered');
            } catch (e) { console.error('Variance error:', e); }

            try {
                renderForecastCharts();
                console.log('‚úÖ Forecast Charts rendered');
            } catch (e) { console.error('Forecast error:', e); }

            try {
                renderAdvancedCharts();
                console.log('‚úÖ Advanced Charts rendered');
            } catch (e) { console.error('Advanced Charts error:', e); }

            console.log('üé¨ Demo Mode Complete!');
        }
    </script>
    <!-- WebGL Financial Scene -->
    <script type="module" src="assets/js/pages/financial-scene.js"></script>
</body>

</html>